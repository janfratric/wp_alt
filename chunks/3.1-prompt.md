# Chunk 3.1 — Template Engine & Front Controller

## Goal

Make the public-facing website functional. Enhance the template engine with section/yield blocks, SEO meta helpers, and a navigation builder. Build a front controller that maps public URLs to published content from the database, renders the correct template, and generates proper SEO meta/Open Graph tags. At completion, visitors can browse pages by slug, read blog posts with pagination, and see auto-generated navigation.

## Context Files

- `PROMPT.md` — Full project specification (tech stack, security, schema)
- `CHUNK-3.1-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `tests/chunk-3.1-verify.php` — Automated tests you MUST pass before declaring done
- `app/Templates/TemplateEngine.php` — Existing engine to extend (DO NOT rewrite existing methods)
- `app/Database/QueryBuilder.php` — Query builder API for fetching content
- `app/Admin/ContentController.php` — Reference for QueryBuilder usage patterns
- `public/index.php` — Entry point where routes are registered

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `app/Templates/TemplateEngine.php` | Modify | Add section/yield, metaTags, navigation, breadcrumbs methods |
| 2 | `app/Templates/FrontController.php` | Create | Public URL→content routing, SEO meta, pagination |
| 3 | `templates/public/layout.php` | Replace | Full HTML5 layout with SEO, dynamic nav, sections |
| 4 | `templates/public/404.php` | Create | Styled 404 page extending public layout |
| 5 | `templates/public/home.php` | Replace | Homepage with recent posts listing |
| 6 | `public/index.php` | Modify | Add FrontController import + public routes |
| 7 | `app/Core/App.php` | Modify | Update 404 fallback to use styled template |

## Class Signatures

### `App\Templates\TemplateEngine` — NEW methods only (keep all existing methods unchanged)

New private properties: `array $sections = []`, `array $sectionStack = []`

```
startSection(string $name): void             // Push name, ob_start()
endSection(): void                            // Pop name, store ob_get_clean() in $sections
yieldSection(string $name, string $default = ''): string  // Return section content or default
hasSection(string $name): bool                // Check if section defined
metaTags(array $meta): string                 // Generate <meta> + OG tags HTML from assoc array
navigation(array $pages, string $currentSlug = ''): string  // Build <ul> nav from page records
breadcrumbs(array $crumbs): string            // Build accessible <nav><ol> breadcrumbs
```

`metaTags()` keys: `description`, `canonical`, `og_title`, `og_description`, `og_type`, `og_url`, `og_image`, `article_author`, `article_published`. Skip empty values. Escape all output.

### `App\Templates\FrontController` (new)

```
__construct(App $app)
homepage(Request $request): Response          // Recent published posts, renders 'public/home'
blogIndex(Request $request): Response         // Paginated posts, ?page=N, renders 'public/blog-index'
blogPost(Request $request, string $slug): Response  // Single post by slug, 404 if not found/published
page(Request $request, string $slug): Response      // Page by slug; posts → 301 to /blog/{slug}
notFound(Request $request): Response          // Styled 404 page, HTTP 404 status
```

Private helpers:
```
getNavPages(): array                          // Published pages sorted by sort_order for nav
isPublished(array $content): bool             // status='published' AND published_at <= now
buildMeta(array $content, string $type = 'website'): array  // SEO meta from content record
renderPublic(string $template, array $data): Response       // Merge nav/site globals, render
```

### `App\Core\App` — change in `run()` method

Replace raw `<h1>404 Not Found</h1>` fallback with `FrontController::notFound()`.

## Route Registration (in `public/index.php`)

Add after admin routes, before `$app->run()` — order matters:
```
GET /              → FrontController::homepage
GET /blog          → FrontController::blogIndex
GET /blog/{slug}   → FrontController::blogPost
GET /{slug}        → FrontController::page        ← MUST be LAST (catch-all)
```

## Key Constraints

- Every `.php` file: `<?php declare(strict_types=1);`
- DO NOT modify existing TemplateEngine methods — only ADD new methods
- All template output uses `$this->e()` for XSS prevention
- All DB queries use QueryBuilder with parameterized bindings — no raw SQL concatenation
- Scheduling: content is visible only if `status='published'` AND (`published_at IS NULL` OR `published_at <= NOW()`)
- Posts accessed at `/{slug}` must 301-redirect to `/blog/{slug}` for canonical URLs
- `/{slug}` catch-all route MUST be registered last to avoid matching `/blog`, `/admin/*`
- `renderPublic()` merges `$navPages`, `$siteName`, `$siteUrl`, `$currentSlug` into every public template
- Navigation includes fixed Home + Blog links plus dynamic published pages sorted by `sort_order`
- No CSS styling in this chunk — templates are functional but unstyled (CSS comes in Chunk 3.2)
- `blogIndex` uses `Config::getInt('items_per_page')` for pagination limit

## Verification

After implementation, run:
```
composer install
php tests/chunk-3.1-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Then run full regression:
```
php tests/run-all.php --full
```

All previous chunks must still pass.

Manual smoke tests:
```
php -S localhost:8000 -t public
```
- `GET /` → 200, homepage with recent posts and navigation
- `GET /blog` → 200, paginated blog listing
- `GET /blog/{slug}` → 200, single post with author, date, OG tags
- `GET /{page-slug}` → 200, page content with meta tags
- `GET /nonexistent` → 404, styled error page with nav
- Draft/archived content → 404
- Future `published_at` → 404
- Admin routes still work (login, dashboard, content CRUD)

## Reference

For full code templates and detailed implementation notes, see `CHUNK-3.1-PLAN.md`.
