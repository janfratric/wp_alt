# Chunk 6.1 — Element Catalogue & Rendering Engine

## Goal

Build the element-based page builder foundation: database schema for reusable UI elements, a micro-mustache template engine (SlotRenderer) for rendering element templates with typed content slots, a PageRenderer for assembling element-based pages, full admin CRUD for the element catalogue, and 7 seed starter elements. At completion, admins can create/edit/preview/delete elements, and the front controller renders element-based pages when `editor_mode = 'elements'`.

## Context Files

- `PROMPT.md` — Full project specification (tech stack, constraints, security requirements)
- `CHUNK-6.1-PLAN.md` — Detailed reference with full code templates and schema (consult if stuck)
- `tests/chunk-6.1-verify.php` — 28 automated tests you MUST pass before declaring done
- `app/Templates/FrontController.php` — Existing front controller to modify (add element-mode branch)
- `public/index.php` — Existing entry point to add element routes
- `templates/admin/layout.php` — Existing admin layout to add Elements nav link
- `templates/public/layout.php` — Existing public layout to add elementCss style block

## Files to Create (in dependency order)

| # | File | Purpose |
|---|------|---------|
| 1 | `migrations/004_page_builder.sqlite.sql` | `elements`, `page_elements`, `element_proposals` tables + `editor_mode` column on `content` |
| 2 | `migrations/004_page_builder.mysql.sql` | MySQL variant of above |
| 3 | `migrations/004_page_builder.pgsql.sql` | PostgreSQL variant of above |
| 4 | `app/PageBuilder/SlotRenderer.php` | Micro-mustache template engine for element slots |
| 5 | `app/PageBuilder/PageRenderer.php` | Assembles element-based pages into HTML + CSS |
| 6 | `app/PageBuilder/SeedElements.php` | 7 starter elements (idempotent seed) |
| 7 | `app/Admin/ElementController.php` | Full CRUD + preview API + JSON list endpoint |
| 8 | `templates/admin/elements/index.php` | Catalogue grid view with category filters |
| 9 | `templates/admin/elements/edit.php` | Element editor (meta, slots, code editors, live preview) |
| 10 | `public/assets/js/element-editor.js` | Slot builder UI + live preview |

## Files to Modify

| # | File | Change |
|---|------|--------|
| 11 | `app/Templates/FrontController.php` | Add `use PageRenderer`, element-mode branch in `page()` and `blogPost()` |
| 12 | `templates/public/layout.php` | Add `<style id="litecms-element-styles">` block for `$elementCss` |
| 13 | `templates/admin/layout.php` | Add "Elements" nav link (`/admin/elements`) |
| 14 | `public/index.php` | Add `use ElementController` + 8 element routes in `/admin` group |
| 15 | `public/assets/css/admin.css` | Add ~400 lines: element grid, cards, editor layout, slot builder, code editor styles |

## Class Signatures

### `App\PageBuilder\SlotRenderer`
```
static render(string $template, array $data): string
```
Private: `processSections()`, `processInvertedSections()`, `resolve()`, `isSequential()`.
Syntax: `{{key}}` (escaped), `{{{key}}}` (raw), `{{#key}}...{{/key}}` (section/loop), `{{^key}}...{{/key}}` (inverted), `{{key.sub}}` (dot notation).

### `App\PageBuilder\PageRenderer`
```
static renderPage(int $contentId): string         // Assembles all element instances into HTML
static getPageCss(int $contentId): string          // Collects deduplicated CSS for all elements
static renderInstance(array $instance): string     // Renders one element, wraps in .lcms-el-{slug} div
```
Private: `loadInstances(int $contentId): array` — joins `page_elements` + `elements`, ordered by `sort_order`.

### `App\PageBuilder\SeedElements`
```
static seed(): int                    // Inserts missing elements, returns count inserted
static definitions(): array           // Returns 7 element definition arrays
```
Private: `heroSection()`, `textSection()`, `featureGrid()`, `ctaBanner()`, `imageText()`, `testimonialSection()`, `faqSection()`.

### `App\Admin\ElementController`
```
__construct(App $app)
index(Request $request): Response                  // GET /admin/elements — list with filters
create(Request $request): Response                 // GET /admin/elements/create
store(Request $request): Response                  // POST /admin/elements
edit(Request $request, string $id): Response       // GET /admin/elements/{id}/edit
update(Request $request, string $id): Response     // PUT /admin/elements/{id} — increments version
delete(Request $request, string $id): Response     // DELETE /admin/elements/{id} — blocks if in use
preview(Request $request, string $id): Response    // GET /admin/elements/{id}/preview — JSON
apiList(Request $request): Response                // GET /admin/elements/api/list — JSON
static generateSampleData(array $slots): array     // Sample data for preview
```
Private: `readFormData()`, `validate()`, `validateSlotsJson()`, `generateSlug()`, `withSecurityHeaders()`.
Constants: `VALID_SLOT_TYPES`, `VALID_STATUSES`.

## Routes

```
GET    /admin/elements              → index
GET    /admin/elements/api/list     → apiList        ← BEFORE {id} routes
GET    /admin/elements/create       → create         ← BEFORE {id} routes
POST   /admin/elements              → store
GET    /admin/elements/{id}/edit    → edit
GET    /admin/elements/{id}/preview → preview
PUT    /admin/elements/{id}         → update
DELETE /admin/elements/{id}         → delete
```

## Slot Type System

`text`, `richtext`, `image`, `link` (url+text+target), `select` (requires options), `boolean`, `number`, `list` (requires sub_slots).

## Seed Elements

`hero-section`, `text-section`, `feature-grid`, `cta-banner`, `image-text`, `testimonial-section`, `faq-section`. All scoped CSS under `.lcms-el-{slug}`, responsive, using CSS custom properties.

## Key Constraints

- Every `.php` file starts with `<?php declare(strict_types=1);`
- No framework imports — native PHP only
- `{{key}}` MUST escape via `htmlspecialchars(... ENT_QUOTES, 'UTF-8')` — XSS prevention
- `{{{key}}}` outputs raw HTML (for richtext slots only)
- Element CSS scoped under `.lcms-el-{slug}` to prevent conflicts
- `ON DELETE RESTRICT` on `element_id` FK — cannot delete elements in use
- `ON DELETE CASCADE` on `content_id` FK — cleanup when content is deleted
- `/elements/api/list` and `/elements/create` registered before `/elements/{id}` routes
- Seed elements are idempotent — check slug existence before inserting
- Slot validation: reject duplicate keys, enforce type-specific requirements (select→options, list→sub_slots)

## Verification

After implementation, run:
```
php tests/chunk-6.1-verify.php
php tests/run-all.php --full
```

All 28 tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

## Reference

For full code templates, database schema DDL, element HTML/CSS definitions, and detailed implementation notes, see `CHUNK-6.1-PLAN.md`.
