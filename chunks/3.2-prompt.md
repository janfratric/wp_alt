# Chunk 3.2 — Public Templates & Styling

## Goal

Make the public-facing site fully presentable and legally compliant. Add a complete mobile-first CSS stylesheet, a contact page with CSRF-protected form, an archive template for custom content types, and an EU cookie consent banner with conditional Google Analytics loading. All existing templates from Chunk 3.1 remain structurally intact — this chunk enhances them with styling, a hero section, and cookie/GA integration.

## Context Files

- `CHUNK-3.2-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `app/Templates/FrontController.php` — Existing front controller to extend
- `templates/public/layout.php` — Existing layout to modify
- `templates/public/home.php` — Existing homepage to modify
- `public/index.php` — Entry point, add contact routes
- `public/assets/css/admin.css` — Reference for design system palette
- `tests/chunk-3.2-verify.php` — Automated tests you MUST pass before declaring done

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `migrations/002_contact_submissions.sqlite.sql` | **Create** | Contact submissions table (SQLite) |
| 2 | `migrations/002_contact_submissions.pgsql.sql` | **Create** | Contact submissions table (PostgreSQL) |
| 3 | `migrations/002_contact_submissions.mysql.sql` | **Create** | Contact submissions table (MySQL) |
| 4 | `public/assets/css/style.css` | **Create** | Complete public stylesheet, mobile-first |
| 5 | `public/assets/js/cookie-consent.js` | **Create** | Cookie consent banner logic + conditional GA |
| 6 | `templates/public/partials/cookie-consent.php` | **Create** | Cookie consent banner HTML partial |
| 7 | `templates/public/contact.php` | **Create** | Contact page with CSRF-protected form |
| 8 | `templates/public/archive.php` | **Create** | Generic archive listing for custom content types |
| 9 | `templates/public/layout.php` | **Modify** | Add CSS link, hamburger toggle, cookie consent, GA data attr |
| 10 | `templates/public/home.php` | **Modify** | Add hero section with tagline and CTA button |
| 11 | `app/Templates/FrontController.php` | **Modify** | Add contact + archive methods, enhance renderPublic() |
| 12 | `public/index.php` | **Modify** | Add GET/POST `/contact` routes before catch-all |

## Migration Schema

**`contact_submissions`** table: `id` (PK auto), `name` (VARCHAR 100, NOT NULL), `email` (VARCHAR 255, NOT NULL), `subject` (VARCHAR 255, default ''), `message` (TEXT, NOT NULL), `ip_address` (VARCHAR 45), `created_at` (TIMESTAMP, default CURRENT_TIMESTAMP). Index on `created_at`. No foreign keys.

## Class Signatures

### `App\Templates\FrontController` (modified)

**New methods:**
```
public contactPage(Request $request): Response
public contactSubmit(Request $request): Response
public archive(Request $request, string $typeSlug): Response
private getPublicSettings(): array
```

**Modified methods:**
```
private renderPublic(string $template, array $data): Response
  — now merges: tagline, consentText, consentLink, gaId from getPublicSettings()
  — now reads/clears $_SESSION['flash_success'] for PRG pattern
```

### `contactPage` behavior
1. Build meta array (title, description, canonical).
2. Read `$_SESSION['flash_success']` (set by contactSubmit after PRG redirect).
3. Render `public/contact` with title, meta, empty `$old[]`, success message.

### `contactSubmit` behavior
1. Read and trim: name, email, subject, message from POST.
2. Validate: name required (max 100), email required + valid format (max 255), subject optional (max 255), message required (max 5000).
3. Validation fail → re-render form with errors and `$old` values.
4. Validation pass → insert into `contact_submissions`, set `$_SESSION['flash_success']`, redirect `/contact` (PRG).

### `archive` behavior
1. Look up `content_types` by slug where `has_archive = 1`. Not found → 404.
2. Query published content of that type with pagination (`items_per_page` config).
3. Render `public/archive` with items, pagination, archiveSlug, archiveTitle.

### `getPublicSettings` behavior
1. Static cache (one DB query per request).
2. Fetch from `settings` table: `site_tagline`, `cookie_consent_text`, `cookie_consent_link`, `ga_enabled`, `ga_measurement_id`.
3. Return associative array. Gracefully handle missing settings table.

## CSS Design System

Shared palette with admin.css:
- Primary: `#2563eb`, hover: `#1d4ed8`
- Font: `-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif`
- Radius: `8px`, container max-width: `1100px`, mobile breakpoint: `768px`
- Use CSS custom properties in `:root` for all values
- Sections: reset, container, header/nav, main, footer, hero, post-cards, pagination, blog-post, page, contact form, archive, 404, breadcrumbs, cookie consent, utilities

## Cookie Consent JS

- IIFE-wrapped, vanilla JS, no dependencies
- Cookie name: `litecms_consent`, 365-day expiry, SameSite=Lax
- Reads GA Measurement ID from `<body data-ga-id="...">`
- Accept → set cookie, hide banner, inject gtag.js script
- Decline → set cookie, hide banner, no GA
- Returning accepted visitor → load GA silently, no banner
- Prevent double-loading of GA script

## Key Constraints

1. No existing backend PHP classes are rewritten — only add methods to FrontController
2. All user output escaped with `$this->e()` (XSS prevention)
3. Contact form uses CSRF via `$this->csrfField()` (global CsrfMiddleware handles validation)
4. Contact form uses PRG pattern — POST validates/stores then redirects to GET
5. No tracking cookies or GA scripts load until user explicitly clicks Accept
6. `data-ga-id` on `<body>` only rendered when `ga_enabled` is `'1'` and `ga_measurement_id` is non-empty
7. Mobile nav uses `<button>` with `aria-expanded` and `aria-label` for accessibility
8. Cookie consent banner has `role="dialog"` and `aria-label`
9. Archive routes are NOT registered in index.php yet (deferred to Chunk 5.1) — only the method is implemented
10. Template files that start with `<?php $this->layout(...)` do not need `declare(strict_types=1)` — it's inherited from the rendering context

## Route Changes (public/index.php)

Add before the `/{slug}` catch-all:
```
GET  /contact  → FrontController::contactPage
POST /contact  → FrontController::contactSubmit
```

## Verification

After implementation, run:
```
composer install
php tests/chunk-3.2-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Then verify manually:
```
php -S localhost:8000 -t public
```
- `GET /` → Hero section with tagline and CTA, styled post cards
- `GET /blog` → Styled blog index with pagination
- `GET /contact` → Contact form renders, submit stores row in DB
- Mobile viewport (375px) → Hamburger nav, stacked cards
- Cookie banner appears on first visit, respects accept/decline

## Reference

For full code templates, CSS source, and detailed implementation notes, see `CHUNK-3.2-PLAN.md`.
