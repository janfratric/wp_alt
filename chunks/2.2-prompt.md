# Chunk 2.2 — Content CRUD (Pages & Posts)

## Goal

Build the full content management interface for pages and posts: listing with search, type/status filters, and pagination; creating and editing with TinyMCE WYSIWYG editor; slug auto-generation; draft/publish/archive workflow; SEO fields; and bulk actions. At completion, admins can create, list, search, filter, edit, and delete pages and blog posts.

## Context Files

- `PROMPT.md` — Full project specification (schema, security, constraints)
- `CHUNK-2.2-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `tests/chunk-2.2-verify.php` — Automated tests you MUST pass before declaring done
- `app/Admin/DashboardController.php` — Controller pattern reference (constructor, response headers)
- `app/Database/QueryBuilder.php` — Query builder API (where, whereRaw, join, count, insert, update, delete)
- `templates/admin/layout.php` — Admin layout structure (activeNav, flash messages, csrfField)
- `templates/admin/dashboard.php` — Template pattern reference (escaping, loops, badges)
- `public/assets/css/admin.css` — Existing CSS classes to reuse
- `public/assets/js/admin.js` — Existing JS (data-confirm, flash auto-dismiss)

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `app/Admin/ContentController.php` | Create | Full CRUD controller (7 public + 6 private methods) |
| 2 | `templates/admin/content/index.php` | Create | Content list with search, filters, pagination, bulk actions |
| 3 | `templates/admin/content/edit.php` | Create | Two-column editor: main (title/slug/TinyMCE/excerpt) + sidebar (publish/SEO/image) |
| 4 | `public/assets/js/editor.js` | Create | TinyMCE CDN loader, slug auto-generation, select-all checkbox |
| 5 | `public/assets/css/admin.css` | Modify | Append: filter bar, pagination, editor layout, slug field, bulk actions |
| 6 | `public/index.php` | Modify | Replace placeholder `/content` route with 7 CRUD routes |

## Class Signatures

### `App\Admin\ContentController`
```
__construct(App $app)
index(Request $request): Response                    // GET /admin/content — list with filters + pagination
create(Request $request): Response                   // GET /admin/content/create — empty editor form
store(Request $request): Response                    // POST /admin/content — validate + insert
edit(Request $request, string $id): Response         // GET /admin/content/{id}/edit — editor with data
update(Request $request, string $id): Response       // PUT /admin/content/{id} — validate + update
delete(Request $request, string $id): Response       // DELETE /admin/content/{id} — delete single
bulk(Request $request): Response                     // POST /admin/content/bulk — bulk delete/status change
```
Private helpers:
```
readFormData(Request $request): array                // Extract all form fields from request
validate(array $data): ?string                       // Returns error message or null
generateSlug(string $title, string $manualSlug = ''): string
ensureUniqueSlug(string $slug, ?int $excludeId = null): string
resolvePublishedAt(string $status, string $publishedAt): string
withSecurityHeaders(Response $response): Response    // X-Frame-Options + CSP (with TinyMCE CDN)
```

## Route Registration (in `public/index.php`)

Add `use App\Admin\ContentController;` to imports. Replace the placeholder `/content` closure inside the `/admin` group with:
```
GET  /content              → [ContentController::class, 'index']
GET  /content/create       → [ContentController::class, 'create']
POST /content              → [ContentController::class, 'store']
GET  /content/{id}/edit    → [ContentController::class, 'edit']
PUT  /content/{id}         → [ContentController::class, 'update']
DELETE /content/{id}       → [ContentController::class, 'delete']
POST /content/bulk         → [ContentController::class, 'bulk']
```

## Key Constraints

- Every `.php` file starts with `<?php declare(strict_types=1);`
- All DB queries via `QueryBuilder` with parameterized bindings — no raw SQL concatenation
- All template output escaped with `$this->e()` — exception: `$content['body']` inside `<textarea>` is output raw (textarea content is inherently text, and TinyMCE needs the raw HTML)
- All mutation forms include `<?= $this->csrfField() ?>` — CSRF middleware validates automatically
- PUT/DELETE use `<input type="hidden" name="_method" value="PUT|DELETE">` in POST forms
- Controller methods receive route params as named string arguments (e.g., `string $id` from `{id}`)
- Template data must include `'activeNav' => 'content'` for sidebar highlighting
- TinyMCE loaded from CDN: `https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js`
- CSP on editor pages must allow `cdn.tiny.cloud` in script-src, style-src, connect-src, font-src
- Delete buttons use `data-confirm="..."` attribute (handled by existing `admin.js`)
- Pagination links must preserve current filter params (type, status, q) via `http_build_query()`
- Featured image is a text input for now (media browser comes in Chunk 2.3)

## CSS to Append

Add these class groups to `admin.css` (see detailed plan for full CSS):
- `.filter-form` — flexbox filter bar with `.search-group`, `.filter-buttons`
- `.pagination` — centered flex with page links and `.page-info`
- `.editor-layout` — CSS grid: `1fr 320px` (stacks on mobile)
- `.slug-field` — flex container with `.slug-prefix` and borderless inner input
- `.bulk-actions` — inline flex for dropdown + button
- Responsive breakpoint: `.editor-layout` → single column at `max-width: 768px`

## Verification

After implementation, run:
```
composer install
php tests/chunk-2.2-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Then run the full regression suite:
```
php tests/run-all.php --full
```

All previous chunks (1.1, 1.2, 1.3, 2.1) must still pass.

Manual verification:
```
php -S localhost:8000 -t public
```
- Login → `/admin/content` → empty list with "New Content" button
- Create a page with title, body (TinyMCE), publish → appears in list
- Slug auto-generates from title; manual edit persists custom slug
- Filter by type "Page" → only pages; filter by status "Draft" → only drafts
- Search by title → correct results
- Bulk select + delete → items removed
- Edit existing content → changes persist
- Create 15+ items → pagination works, filters preserved across pages

## Reference

For full code templates, implementation notes, and edge cases, see `CHUNK-2.2-PLAN.md`.
