# Chunk 6.2 — Content Editor Element Mode & Page Builder UI

## Goal

Add element-based editing mode to the content editor. When `editor_mode = 'elements'`, display a page builder panel (element picker modal, slot data forms, drag-and-drop reordering, JSON serialization) instead of TinyMCE. Update ContentController to persist and restore `page_elements` rows. Existing HTML-mode content remains completely unaffected.

## Context Files

- `CHUNK-6.2-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `templates/admin/content/edit.php` — Existing content editor template (you will modify this)
- `app/Admin/ContentController.php` — Existing content CRUD controller (you will modify this)
- `public/assets/css/admin.css` — Existing admin stylesheet (you will append styles)
- `public/assets/js/element-editor.js` — Element catalogue editor JS (reference for patterns)
- `public/assets/js/editor.js` — TinyMCE/media browser JS (reference for media integration)
- `tests/chunk-6.2-verify.php` — Automated tests you MUST pass before declaring done

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `public/assets/js/page-builder.js` | CREATE | Page builder UI: element picker, slot forms, drag-drop, JSON serialization (~550-650 lines) |
| 2 | `templates/admin/content/edit.php` | MODIFY | Add editor mode toggle, page builder panel, picker modal, init script |
| 3 | `app/Admin/ContentController.php` | MODIFY | Handle editor_mode, save/load page_elements rows |
| 4 | `public/assets/css/admin.css` | MODIFY | Append ~300 lines of page builder styles |

## Class/Module Signatures

### `page-builder.js` — IIFE module

**Entry point**: `window.initPageBuilder(existingInstances, csrfToken)`

**State**: `instances[]`, `catalogue[]`, `pickerModal`, `instanceList`, `jsonInput`, `csrfToken`, `dragSrcIndex`

```
initPageBuilder(existingInstances, csrf)       // Init DOM refs, parse existing instances, render, fetch catalogue
fetchCatalogue(callback)                       // GET /admin/elements/api/list, cache result
openPicker()                                   // Show picker modal with search + category tabs + element grid
closePicker()                                  // Hide picker modal
renderPickerContent(searchTerm, categoryFilter) // Filter/render catalogue cards in modal
addElement(elementDef)                         // Create instance from catalogue entry, push, render, scroll
buildDefaultSlotData(slots) → object           // Default values per slot type (text→'', boolean→false, etc.)
removeInstance(index)                          // Confirm + splice + re-render
renderAllInstances()                           // Clear + rebuild all instance cards + count badge
createInstanceCard(instance, index) → HTMLElement  // Card: drag handle, name, category, collapse, remove, slot fields
createSlotField(slot, slotData, index) → HTMLElement  // Input by type: text, richtext, image, link, select, boolean, number, list
createListItem(subSlots, itemData, itemIndex) → HTMLElement  // List sub-item with sub-slot fields + remove
readInstancesFromDOM()                         // Walk DOM inputs → update instances[].slotData
serializeInstances()                           // readInstancesFromDOM → JSON.stringify → jsonInput.value
handleDragStart(e, index)                      // Set dragSrcIndex, add .pb-dragging
handleDragOver(e, index)                       // preventDefault, add .pb-drag-over
handleDrop(e, index)                           // Splice + reinsert instance, re-render
handleDragEnd(e)                               // Remove drag classes, reset dragSrcIndex
escHtml(str) → string                          // HTML-escape via textContent trick
escAttr(str) → string                          // Escape &, ", <, > for attributes
```

### Slot field types and their rendered inputs:
- `text` → `<input type="text">`
- `richtext` → `<textarea rows="5">`
- `image` → hidden input + Browse Media button + preview img + Remove button
- `link` → 3 fields: URL input, Link Text input, target `<select>`
- `select` → `<select>` with `slot.options`
- `boolean` → `<input type="checkbox">`
- `number` → `<input type="number">`
- `list` → container with Add Item button; each item renders sub-slot fields recursively

All inputs use `data-instance="{index}" data-slot="{slot.key}"` attributes for DOM reading.

### `App\Admin\ContentController` (modified methods + new private methods)

```
MODIFIED:
  readFormData(Request): array               — add 'editor_mode' => $request->input('editor_mode', 'html')
  create(Request): Response                  — add editor_mode to $content defaults, pass pageElements=[] + csrfToken
  store(Request): Response                   — add editor_mode to insert, call savePageElements() if elements mode
  edit(Request, string): Response            — call loadPageElements(), pass pageElements + csrfToken to template
  update(Request, string): Response          — add editor_mode to update, call savePageElements() if elements mode

NEW PRIVATE:
  savePageElements(int $contentId, Request $request): void
      — Delete existing page_elements for content_id
      — Parse elements_json from request, validate each element_id exists
      — Insert rows with content_id, element_id, sort_order, slot_data_json

  loadPageElements(int $contentId): array
      — Query page_elements LEFT JOIN elements WHERE content_id, ORDER BY sort_order
      — Return [{elementId, elementSlug, elementName, elementCategory, slots, slotData}, ...]
```

### `templates/admin/content/edit.php` (modifications)

- Add editor mode radio toggle (html / elements) after slug field
- Wrap existing body textarea in `#html-editor-panel` div (hidden when elements mode)
- Add `#page-builder-panel` div with: toolbar (Add Element + count badge), instance list, empty state, hidden `elements_json` input
- Add `#pb-picker-modal` with overlay, header, search, category tabs, grid
- Add `<script>` for mode toggle logic + `initPageBuilder(existingInstances, csrfToken)` call

## Key Constraints

1. Every `.php` file starts with `<?php declare(strict_types=1);`
2. No framework imports — native PHP only; vanilla JS only (no npm/build step)
3. `editor_mode` validated server-side to only accept `'html'` or `'elements'`
4. Each `element_id` in `elements_json` verified against `elements` table before insert
5. Reuse existing media browser modal from editor.js for image slot fields
6. TinyMCE coexistence: when mode is `elements`, body textarea is hidden but content preserved; no data lost on mode switch
7. All template output uses `$this->e()` for escaping; slot data stored as JSON (no SQL interpolation)
8. No new database migrations — schema from 6.1 already has `editor_mode` column, `page_elements` table
9. No new admin routes — uses existing `/admin/elements/api/list` from 6.1
10. Public rendering unchanged — FrontController already handles element-mode pages from 6.1

## Verification

After implementation, run:
```
php tests/chunk-6.2-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Then verify manually:
- `GET /admin/content/create` → mode toggle visible, default HTML mode, switch to Page Builder shows panel
- Add elements via picker → instance cards render with correct slot fields
- Fill slot data, save → page_elements rows persisted with correct sort_order and slot_data_json
- Edit saved content → instances restored with filled slot data
- Drag-and-drop reorder → order changes persist on save
- HTML-mode content remains completely unaffected
- Public page with element-mode content renders correctly

## Reference

For full code templates, CSS blocks, and detailed implementation notes, see `CHUNK-6.2-PLAN.md`.
