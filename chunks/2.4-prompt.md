# Chunk 2.4 — User Management

## Goal

Build the admin-only user management interface: list users with search/pagination, create new users with role assignment (admin/editor), edit user details and passwords, and delete users with content reassignment. Editors must be denied access to the entire section via `RoleMiddleware`.

## Context Files

- `PROMPT.md` — Full project specification (schema, security requirements)
- `CHUNK-2.4-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `app/Admin/ContentController.php` — Pattern to follow for CRUD, pagination, validation, security headers
- `app/Auth/RoleMiddleware.php` — Role checking (use `RoleMiddleware::check('admin')`)
- `app/Auth/Session.php` — Session management and flash messages
- `templates/admin/content/index.php` — Template pattern for list pages (table, filters, pagination)
- `templates/admin/content/edit.php` — Template pattern for edit forms
- `public/index.php` — Route registration (modify to add user routes)
- `tests/chunk-2.4-verify.php` — Automated tests you MUST pass before declaring done

## Files to Create/Modify (in order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `app/Admin/UserController.php` | CREATE | Full CRUD controller with role enforcement |
| 2 | `templates/admin/users/index.php` | CREATE | User list with search, pagination, delete modal |
| 3 | `templates/admin/users/edit.php` | CREATE | Create/edit form with password handling |
| 4 | `public/index.php` | MODIFY | Replace placeholder `/users` route with 6 CRUD routes |

## Class Signatures

### `App\Admin\UserController`
```
__construct(App $app)

index(Request $request): Response              // GET /admin/users — list + search + pagination
create(Request $request): Response             // GET /admin/users/create — empty form
store(Request $request): Response              // POST /admin/users — validate + insert
edit(Request $request, string $id): Response   // GET /admin/users/{id}/edit — load + form
update(Request $request, string $id): Response // PUT /admin/users/{id} — validate + update
delete(Request $request, string $id): Response // DELETE /admin/users/{id} — reassign + delete
```
Private helpers:
```
readFormData(Request $request): array
validate(array $data, bool $isNew, ?int $excludeId = null): ?string
withSecurityHeaders(Response $response): Response
```

Every public method starts with `RoleMiddleware::check('admin')` — return 403 if denied.

## Routes (inside existing `/admin` group)

Replace the placeholder closure for `/users` with:
```
GET    /admin/users              → UserController::index
GET    /admin/users/create       → UserController::create
POST   /admin/users              → UserController::store
GET    /admin/users/{id}/edit    → UserController::edit
PUT    /admin/users/{id}         → UserController::update
DELETE /admin/users/{id}         → UserController::delete
```

## Key Constraints

- Every public method must call `RoleMiddleware::check('admin')` first — editors get 403
- Passwords hashed with `password_hash($password, PASSWORD_BCRYPT)` — never stored plain
- Self-deletion prevented: if `$id === Session::get('user_id')`, flash error and redirect
- Self-role-change prevented: admin cannot demote/promote themselves
- Password change on own account requires `current_password` verified via `password_verify()`
- Admin resetting another user's password does NOT require current password
- Username uniqueness validated (exclude current user on edit)
- Email uniqueness validated (exclude current user on edit)
- Username format: `/^[a-zA-Z0-9_]+$/`, max 50 chars
- Deleting a user who has content requires `reassign_to` — update `content.author_id` before delete
- If editing own account and username changed, call `Session::set('user_name', ...)` to sync sidebar
- All template output escaped with `$this->e()`, all queries via `QueryBuilder` (parameterized)

## Validation Rules (`validate()`)

1. Username: required, alphanumeric+underscore, max 50, unique
2. Email: required, `FILTER_VALIDATE_EMAIL`, max 255, unique
3. Role: must be `admin` or `editor`
4. Password: required on create, optional on edit, min 6 chars when provided

## Verification

After implementation, run:
```
composer install
php tests/chunk-2.4-verify.php
php tests/run-all.php --quick
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Then verify manually:
- Log in as admin → `/admin/users` shows user list
- Create editor user → appears in list, can log in
- Edit user → change role, change password works
- Delete user with content → reassignment modal, content transferred
- Log in as editor → `/admin/users` returns 403
- Cannot delete own account (button hidden + server enforced)
- Cannot change own role (field disabled + server enforced)

## Reference

For full code templates, detailed implementation notes, and edge cases, see `CHUNK-2.4-PLAN.md`.
