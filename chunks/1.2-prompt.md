# Chunk 1.2 — Database Layer & Migrations

## Goal

Build the database foundation: a PDO connection factory supporting SQLite, PostgreSQL, and MariaDB via a single config switch, a fluent query builder that abstracts SQL dialect differences with parameterized queries, and a migration system that tracks and applies numbered SQL files idempotently. Run the initial migration to create all 7 schema tables.

## Context Files

- `PROMPT.md` — Full project specification (schema definitions in the Database module section)
- `CHUNK-1.2-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `config/app.php` — Existing config with db_driver, db_path, db_host, etc.
- `app/Core/Config.php` — Config reader you'll use for database settings
- `app/Core/App.php` — App container where the DB connection gets registered
- `public/index.php` — Entry point to modify (add DB bootstrap)
- `tests/chunk-1.2-verify.php` — Automated tests you MUST pass before declaring done

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `app/Database/Connection.php` | Create | PDO singleton factory — SQLite/PostgreSQL/MariaDB via config |
| 2 | `app/Database/QueryBuilder.php` | Create | Fluent query builder — parameterized SELECT/INSERT/UPDATE/DELETE |
| 3 | `app/Database/Migrator.php` | Create | Migration runner — tracks applied migrations in `_migrations` table |
| 4 | `migrations/001_initial.sqlite.sql` | Create | All 7 tables for SQLite |
| 5 | `migrations/001_initial.pgsql.sql` | Create | All 7 tables for PostgreSQL |
| 6 | `migrations/001_initial.mysql.sql` | Create | All 7 tables for MariaDB |
| 7 | `public/index.php` | Modify | Add DB bootstrap (connection + auto-migrate) before routes |

## Class Signatures

### `App\Database\Connection`
```
static getInstance(): PDO                    // Singleton — creates on first call
static getDriver(): string                   // Returns 'sqlite', 'pgsql', or 'mysql'
static reset(): void                         // Clears singleton (testing only)
```
Private helpers: `createConnection()`, `connectSqlite()`, `connectPgsql()`, `connectMysql()`.
PDO settings: `ERRMODE_EXCEPTION`, `FETCH_ASSOC`, `EMULATE_PREPARES=false`.
SQLite extras: `PRAGMA journal_mode=WAL`, `PRAGMA foreign_keys=ON`. Auto-creates directory/file.

### `App\Database\QueryBuilder`
```
__construct(?PDO $pdo = null)                // Defaults to Connection::getInstance()
select(string ...$columns): self
table(string $table): self
from(string $table): self                    // Alias for table()
where(string $column, mixed $operatorOrValue, mixed $value = null): self
whereRaw(string $sql, array $params = []): self
orderBy(string $column, string $direction = 'ASC'): self
limit(int $limit): self
offset(int $offset): self
join(string $table, string $col1, string $op, string $col2, string $type = 'INNER'): self
leftJoin(string $table, string $col1, string $op, string $col2): self
insert(array $data): string                  // Returns lastInsertId
update(array $data): int                     // Returns affected rows
delete(): int                                // Returns affected rows
get(): array                                 // Execute SELECT, return all rows
first(): ?array                              // Execute SELECT, return first row or null
count(): int                                 // Execute SELECT COUNT(*)
static query(string $table): self            // Factory — new builder for table
static raw(string $sql, array $params = []): PDOStatement
```
`where()` supports 2-arg (`where('id', 5)`) and 3-arg (`where('status', '>', 'draft')`). IN clauses expand to individual placeholders. All queries use named parameters — SQL injection impossible by design.

### `App\Database\Migrator`
```
__construct(?PDO $pdo = null, ?string $migrationsPath = null)
migrate(): array                             // Apply pending migrations, return filenames
getApplied(): array                          // List applied migration filenames
hasBeenApplied(string $migration): bool
```
Private helpers: `ensureMigrationsTable()`, `getAppliedMigrations()`, `getAvailableMigrations()`, `applyMigration(string $filename)`, `getDriverSuffix()`.
Scans for `*.{driver}.sql` files. Applies in transaction. Records in `_migrations` table.

## Schema Tables (7 total)

`users`, `content`, `content_types`, `custom_fields`, `media`, `settings`, `ai_conversations` — exact columns defined in PROMPT.md §Database module. Key dialect differences per driver:

| Concern | SQLite | PostgreSQL | MariaDB |
|---------|--------|------------|---------|
| Auto-increment | `INTEGER PRIMARY KEY AUTOINCREMENT` | `SERIAL PRIMARY KEY` | `INT AUTO_INCREMENT PRIMARY KEY` |
| Boolean | `INTEGER` (0/1) | `BOOLEAN` | `TINYINT(1)` |
| Timestamps | `DATETIME DEFAULT CURRENT_TIMESTAMP` | `TIMESTAMP DEFAULT CURRENT_TIMESTAMP` | `TIMESTAMP DEFAULT CURRENT_TIMESTAMP` |

MySQL: backtick-quote `key` column in settings table (reserved word). Use `ENGINE=InnoDB DEFAULT CHARSET=utf8mb4`. `published_at TIMESTAMP NULL DEFAULT NULL`. Add `ON UPDATE CURRENT_TIMESTAMP` for `updated_at` columns.

## `public/index.php` Modification

Add after `$app = new App()` and before route registration:
```php
use App\Database\Connection;
use App\Database\Migrator;

$db = Connection::getInstance();
$app->register('db', $db);

$migrator = new Migrator($db);
$migrator->migrate();
```

## Key Constraints

- Every `.php` file starts with `<?php declare(strict_types=1);`
- All database queries use PDO prepared statements with named parameters
- No ORM — only the custom QueryBuilder with raw PDO
- QueryBuilder is single-use (one instance per query, use `query()` factory)
- Migrations are idempotent — running twice applies nothing the second time
- SQLite must enable foreign keys (`PRAGMA foreign_keys=ON`)
- Relative `db_path` resolved against project root; support Windows paths (`C:\...`)
- Migration files use `exec()` (supports multiple statements separated by `;`)
- Do NOT modify any existing Chunk 1.1 classes — only add new files + modify `index.php`
- Add indexes on frequently queried columns (slug, type, status, author_id, etc.)

## Verification

After implementation, run:
```
php tests/chunk-1.2-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Then run the cumulative regression check:
```
php tests/run-all.php --full
```

Both chunk 1.1 and 1.2 tests must pass.

## Reference

For full code templates and detailed implementation notes, see `CHUNK-1.2-PLAN.md`.
