# Chunk 7.6 — Template System & Theme Integration

## Goal

Extend the design system to site-wide theming. Allow `.pen` design files to define visual variables (colors, fonts, spacing) that admins can override from the Settings page. Add light/dark theme switching on the public site driven by `.pen` design variables. Wire `.pen` files as layout template options and support per-page theme overrides.

## Context Files

- `CHUNK-7.6-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `tests/chunk-7.6-verify.php` — Automated tests you MUST pass before declaring done
- `app/PageBuilder/PenConverter.php` — Existing converter (generates `:root` CSS vars and `[data-theme-mode="dark"]` selectors)
- `app/Admin/SettingsController.php` — Existing settings controller (key-value store)
- `app/Templates/FrontController.php` — Existing front controller (public site rendering)
- `app/Admin/LayoutController.php` — Existing layout controller (layout CRUD)
- `app/Admin/ContentController.php` — Content CRUD (already has `editor_mode`, `design_file`)
- `app/PageBuilder/PageRenderer.php` — Static `renderFromPen()` helper
- `templates/public/layout.php` — Public site layout template
- `templates/admin/settings.php` — Settings page template

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `migrations/011_theme_settings.sqlite.sql` | Create | Add `content.theme_override` + `layout_templates.pen_file` columns |
| 2 | `migrations/011_theme_settings.mysql.sql` | Create | Same for MySQL |
| 3 | `migrations/011_theme_settings.pgsql.sql` | Create | Same for PostgreSQL |
| 4 | `public/assets/js/theme-toggle.js` | Create | Client-side theme switching (IIFE, localStorage + cookie, toggle button) |
| 5 | `app/PageBuilder/PenConverter.php` | Modify | Add `$variableOverrides`, `setVariableOverrides()`, `extractVariables()`, override injection in `buildVariableCss()`, optional overrides in `convertFile()`/`convertDocument()` |
| 6 | `app/Admin/SettingsController.php` | Modify | Add "Design System" section: load .pen variables, save overrides |
| 7 | `templates/admin/settings.php` | Modify | Add Design System UI: file selector, theme default, toggle checkbox, variable override fields |
| 8 | `app/Templates/FrontController.php` | Modify | Add `resolveTheme()`, `getVariableOverrides()`, pass theme data to templates, pass overrides to PenConverter |
| 9 | `templates/public/layout.php` | Modify | Add `data-theme-mode` on `<html>` + `<body>`, theme toggle button, load theme-toggle.js |
| 10 | `public/assets/css/style.css` | Modify | Add theme toggle button CSS + dark theme overrides for site chrome |
| 11 | `app/Admin/LayoutController.php` | Modify | Add `pen_file` field to form data, save to DB, pass designFiles to templates |
| 12 | `templates/admin/layouts/edit.php` | Modify | Add `.pen` file selector dropdown |
| 13 | `templates/admin/content/edit.php` | Modify | Add per-page theme override selector |
| 14 | `app/Admin/ContentController.php` | Modify | Add `theme_override` to form data, save to DB |
| 15 | `app/PageBuilder/PageRenderer.php` | Modify | Add optional `$variableOverrides` param to `renderFromPen()` |
| 16 | `public/assets/css/admin.css` | Modify | Add design variables editor styles |

## Class Signatures

### `App\PageBuilder\PenConverter` (modifications)

```
private array $variableOverrides = []

public setVariableOverrides(array $overrides): void
    — Store runtime variable overrides from admin settings

public static extractVariables(string $penPath): array
    — Read .pen file, extract variable metadata
    — Returns: ['varName' => ['type'=>..., 'themed'=>bool, 'values'=>['default'=>..., 'mode:dark'=>...]]]

public static convertFile(string $penPath, array $variableOverrides = []): array
    — MODIFY: accept optional overrides, pass to instance

public static convertDocument(array $document, array $variableOverrides = []): array
    — MODIFY: accept optional overrides, pass to instance

private buildVariableCss(): string
    — MODIFY: after :root block, append override :root block if $variableOverrides not empty
```

### `App\Admin\SettingsController` (modifications)

```
index() — MODIFY: load design system file, extract variables, pass designFiles/designVars/varOverrides/defaultTheme/themeToggleEnabled to template
update() — MODIFY: save design_system_file, default_theme_mode, theme_toggle_enabled, design_variable_overrides (JSON)
```

### `App\Templates\FrontController` (modifications)

```
private resolveTheme(Request $request, array $content = []): string
    — Priority: page override > query param > cookie > site default

private getVariableOverrides(): array
    — Return design variable overrides from settings

renderPublic(string $template, array $data, ?Request $request = null): Response
    — MODIFY: accept $request, pass activeTheme/defaultTheme/themeOverride/themeToggleEnabled

getPublicSettings(): array
    — MODIFY: also fetch design_system_file, design_variable_overrides, default_theme_mode, theme_toggle_enabled
```

### `App\Admin\LayoutController` (modifications)

```
readFormData() — MODIFY: add 'pen_file' field
store()/update() — MODIFY: save pen_file to layout_templates table
edit()/create() — MODIFY: load designFiles list, pass to template
```

### `App\Admin\ContentController` (modifications)

```
readFormData() — MODIFY: add 'theme_override' field
store()/update() — MODIFY: save theme_override to content table (NULL when empty)
```

### `App\PageBuilder\PageRenderer` (modifications)

```
public static renderFromPen(string $penFilePath, array $variableOverrides = []): array
    — MODIFY: pass overrides to PenConverter::convertFile
```

## Schema Changes

```sql
ALTER TABLE content ADD COLUMN theme_override VARCHAR(50) DEFAULT NULL;
ALTER TABLE layout_templates ADD COLUMN pen_file VARCHAR(500) DEFAULT NULL;
```

## Key Constraints

- Variable overrides sanitized: strip `;`, `{`, `}`, `<`, `>`, `javascript:`, `@import`
- Variable names sanitized: only `[a-zA-Z0-9_-]` allowed
- Theme values validated against whitelist: `['light', 'dark']`
- Override `:root` block appears *after* the .pen file's `:root` block (CSS cascade wins)
- Theme toggle sets `data-theme-mode` on both `<html>` and `<body>` (PenConverter generates `[data-theme-mode="dark"]` selectors)
- Theme priority cascade: per-page override > `?theme=` query > cookie > site default
- Theme JS runs immediately as IIFE to prevent flash of wrong theme
- Persists to both localStorage and cookie (cookie enables server-side detection)
- `extractVariables()` runs only on settings page load — not on every public request
- No new routes needed — all functionality added to existing controllers
- Use `$this->e()` for all template output (XSS prevention)

## Verification

After implementation, run:
```
composer install
php tests/chunk-7.6-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

## Reference

For full code templates and detailed implementation notes, see `CHUNK-7.6-PLAN.md`.
