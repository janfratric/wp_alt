# Chunk 5.1 — Custom Content Types

## Goal

Build the system for defining and managing custom content types with configurable fields. Admins create content types (e.g., "Products", "Team Members") with custom fields (text, textarea, image, select, boolean). The existing content CRUD extends to support custom types and their fields, and public archive routes are dynamically registered.

## Context Files

- `PROMPT.md` — Full project specification
- `CHUNK-5.1-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `tests/chunk-5.1-verify.php` — Automated tests you MUST pass before declaring done
- `app/Admin/ContentController.php` — Existing content CRUD (will be modified)
- `public/index.php` — Route registration (will be modified)
- `templates/admin/layout.php` — Admin sidebar nav (will be modified)
- `templates/admin/content/index.php` — Content list template (will be modified)
- `templates/admin/content/edit.php` — Content editor template (will be modified)

## Files to Create (in dependency order)

| # | File | Purpose |
|---|------|---------|
| 1 | `app/Admin/ContentTypeController.php` | CRUD controller for content type definitions |
| 2 | `templates/admin/content-types/index.php` | List all custom content types |
| 3 | `templates/admin/content-types/edit.php` | Create/edit form with field builder UI |
| 4 | `public/assets/js/field-builder.js` | Dynamic field builder (add/remove/reorder fields) |

## Files to Modify

| # | File | Change |
|---|------|--------|
| 5 | `templates/admin/layout.php` | Add "Content Types" nav link after Media |
| 6 | `public/index.php` | Add content type admin routes + dynamic public archive routes |
| 7 | `app/Admin/ContentController.php` | Accept custom types, load/save custom fields |
| 8 | `templates/admin/content/index.php` | Dynamic type filter dropdown, show custom type names |
| 9 | `templates/admin/content/edit.php` | Dynamic type dropdown, render custom fields section |

## Class Signatures

### `App\Admin\ContentTypeController`
```
CONSTANTS:
  RESERVED_SLUGS = ['page', 'post', 'blog', 'admin', 'contact', 'assets', 'storage']
  VALID_FIELD_TYPES = ['text', 'textarea', 'image', 'select', 'boolean']

PUBLIC:
  __construct(App $app)
  index(Request $request): Response              // GET /admin/content-types
  create(Request $request): Response             // GET /admin/content-types/create
  store(Request $request): Response              // POST /admin/content-types
  edit(Request $request, string $id): Response   // GET /admin/content-types/{id}/edit
  update(Request $request, string $id): Response // PUT /admin/content-types/{id}
  delete(Request $request, string $id): Response // DELETE /admin/content-types/{id}

PRIVATE:
  readFormData(Request $request): array          // Returns [name, slug, has_archive, fields_json]
  validate(array $data, ?int $excludeId = null): ?string
  generateSlug(string $name, string $manualSlug = ''): string
  validateFieldsJson(string $json): ?string      // Validates field array structure
  withSecurityHeaders(Response $response): Response
```

### `ContentController` modifications
```
index():    Query content_types table, pass $contentTypes to template
create():   Accept custom type slugs, load field definitions, pass to template
store():    After content insert, save custom_fields rows
edit():     Load field definitions + custom_fields values, pass to template
update():   Delete old custom_fields, re-insert from form data
validate(): Accept custom type slugs (not just page/post)
```

### `field-builder.js`
```
initFieldBuilder(initialFields)  // Render existing fields, bind events
addFieldRow(field)               // Append field card to DOM
removeFieldRow(index)            // Splice + re-render
moveFieldRow(from, to)           // Swap + re-render
serializeFields()                // Read DOM → JSON → hidden input
```

## Routes to Register

```
Admin (inside /admin group):
  GET    /content-types              → ContentTypeController::index
  GET    /content-types/create       → ContentTypeController::create
  POST   /content-types              → ContentTypeController::store
  GET    /content-types/{id}/edit    → ContentTypeController::edit
  PUT    /content-types/{id}         → ContentTypeController::update
  DELETE /content-types/{id}         → ContentTypeController::delete

Public (dynamic, before catch-all):
  GET    /{typeSlug}                 → FrontController::archive  (if has_archive=1)
  GET    /{typeSlug}/{slug}          → FrontController::page
```

## Key Constraints

- `content_types` and `custom_fields` tables already exist in migration `001_initial`
- Reserved slugs (page, post, blog, admin, contact, assets, storage) must be rejected
- Field JSON validation: each field needs key (a-z0-9_), label, type; select type requires non-empty options array
- Field keys must be unique within a content type
- Slug change on content type must cascade: `UPDATE content SET type = :new WHERE type = :old`
- Cannot delete a content type that has content items referencing it
- Dynamic archive routes wrapped in try/catch (table may not exist during first migration)
- Boolean checkbox: on update, delete all custom_fields then re-insert (unchecked = no row)
- Image field type reuses existing media browser via `window.open` + `postMessage`
- `$this->e()` for all template output; parameterized queries for all DB operations

## Verification

After implementation, run:
```
composer install
php tests/chunk-5.1-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Manual verification:
- `GET /admin/content-types` — lists types, empty state on fresh install
- Create "Products" type with price (text), description (textarea), featured (boolean) fields
- `GET /admin/content/create?type=products` — shows custom fields in editor
- Create a product, verify `custom_fields` table populated
- Edit product, verify values persist
- `GET /admin/content` — type filter includes "Products"
- Publish product, visit `/products/` — archive renders
- Visit `/products/{slug}` — single item renders
- Delete all products, then delete the content type — succeeds
- Try creating a type with slug "blog" — validation error

## Reference

For full code templates and detailed implementation notes, see `CHUNK-5.1-PLAN.md`.
