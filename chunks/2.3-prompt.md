# Chunk 2.3 — Media Management

## Goal

Build the media upload system and library browser: file upload with validation (type whitelist, MIME check, size limit), storage with randomized filenames in year/month subdirectories, media library grid with pagination and deletion, and integration into the content editor (featured image picker + TinyMCE inline image insertion via a media browser modal).

## Context Files

- `PROMPT.md` — Full project specification
- `CHUNK-2.3-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `tests/chunk-2.3-verify.php` — Automated tests you MUST pass before declaring done
- `app/Core/Request.php` — Request class to modify (add file upload methods)
- `app/Admin/ContentController.php` — Reference for controller patterns (pagination, security headers)
- `public/assets/js/editor.js` — Current editor JS to extend
- `templates/admin/content/edit.php` — Template to modify (featured image card)
- `public/index.php` — Routes file to update

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `app/Core/Request.php` | **Modify** | Add `file()` and `hasFile()` methods for `$_FILES` access |
| 2 | `config/app.php` | **Modify** | Add `max_upload_size` config key (default 5MB = 5242880) |
| 3 | `public/assets/uploads/.htaccess` | **Create** | Disable PHP/script execution in uploads directory |
| 4 | `app/Admin/MediaController.php` | **Create** | Media CRUD: index, upload, delete, browse (AJAX JSON) |
| 5 | `templates/admin/media/index.php` | **Create** | Media library grid with upload form (drag & drop zone) |
| 6 | `public/assets/css/admin.css` | **Modify** | Append upload zone, media grid, media browser modal styles |
| 7 | `public/assets/js/editor.js` | **Modify** | Add media browser modal, TinyMCE image_upload_handler, featured image picker |
| 8 | `templates/admin/content/edit.php` | **Modify** | Replace featured image text placeholder with browse button + preview |
| 9 | `public/index.php` | **Modify** | Replace placeholder media route with 4 MediaController routes |

## Class Signatures

### `App\Core\Request` — Add Methods
```
file(string $key): ?array               // Returns $_FILES[$key] or null if missing/no-file
hasFile(string $key): bool              // True if file was uploaded for given input name
```

### `App\Admin\MediaController`
```
__construct(App $app)
index(Request $request): Response       // GET /admin/media — grid + pagination
upload(Request $request): Response      // POST /admin/media/upload — validate & store
delete(Request $request, string $id): Response  // DELETE /admin/media/{id}
browse(Request $request): Response      // GET /admin/media/browse — JSON for modal

// Private helpers:
getUploadsPath(): string                // dirname(__DIR__, 2) . '/public/assets/uploads/'
formatFileSize(int $bytes): string      // Human-readable B/KB/MB
uploadError(string $message, bool $isAjax): Response
uploadErrorMessage(int $errorCode): string   // Maps UPLOAD_ERR_* to message
withSecurityHeaders(Response $response): Response
```

**Constants:**
```
ALLOWED_EXTENSIONS = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'pdf']
ALLOWED_MIMES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf']
```

### Routes (inside existing admin group)
```
GET    /admin/media         → MediaController::index
GET    /admin/media/browse  → MediaController::browse
POST   /admin/media/upload  → MediaController::upload
DELETE /admin/media/{id}    → MediaController::delete
```
Place explicit routes (`/browse`, `/upload`) before parameterized `/{id}`.

## Key Constraints

- Every `.php` file starts with `<?php declare(strict_types=1);`
- Upload validation order: check file presence → upload errors → extension whitelist → MIME check via `finfo_file()` → size limit
- Randomized filenames: `bin2hex(random_bytes(16)) . '.' . $ext` — never use original filename on disk
- Storage path: `public/assets/uploads/{YYYY}/{MM}/{hash}.{ext}` — create subdirs with `mkdir($dir, 0755, true)`
- DB `media.filename` stores relative path from uploads root (e.g., `2026/02/abc123.jpg`)
- Frontend URLs: `/assets/uploads/2026/02/abc123.jpg`
- AJAX detection: `$request->isAjax()` — return JSON for AJAX, redirect with flash for forms
- `browse` endpoint filters images only when `?type=image` query param is set (uses `whereRaw('mime_type LIKE :mime', ...)`)
- All template output uses `$this->e()` for XSS prevention
- CSRF token required on all POST/DELETE (existing CsrfMiddleware handles this)
- Featured image card: hidden input stores URL, preview img, Browse/Remove buttons wired via JS
- TinyMCE: add `images_upload_handler` for drag-and-drop upload, add `mediabrowser` custom toolbar button

## Verification

After implementation, run:
```
composer install
php tests/chunk-2.3-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Then verify manually:
```
php -S localhost:8000 -t public
```
- `GET /admin/media` — shows media library grid (empty state initially)
- Upload a JPG — appears in grid, file on disk at `uploads/YYYY/MM/{hash}.jpg`
- Upload a `.php` file — rejected with "File type not allowed"
- Rename PHP to `.jpg` and upload — rejected with "File content does not match its extension"
- Delete a media item — file removed from disk + DB
- Content editor → TinyMCE media browser button → modal shows images → select inserts `<img>`
- Content editor → Featured Image → Browse Media → select → preview shown → Remove clears it

## Reference

For full code templates and detailed implementation notes, see `CHUNK-2.3-PLAN.md`.
