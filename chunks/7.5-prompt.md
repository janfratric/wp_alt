# Chunk 7.5 — Admin Integration & Preview

## Goal

Wire the embedded Pencil editor into the content editing workflow. Add a "Design Editor" tab alongside HTML/Elements in the content editor with split-pane editor + preview. Build a design file browser page at `/admin/design/browser`. Add a reconvert endpoint so users can re-convert `.pen` files to HTML on demand.

## Context Files

- `CHUNK-7.5-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `tests/chunk-7.5-verify.php` — Automated tests you MUST pass before declaring done
- `app/Admin/DesignController.php` — Existing design controller (has editor, load, save, convert, preview, list, importFile)
- `app/Admin/ContentController.php` — Existing content controller (already validates `editor_mode` for `['html', 'elements', 'design']`)
- `templates/admin/content/edit.php` — Content edit template (currently shows HTML + Elements modes only)
- `templates/admin/design/editor.php` — Existing standalone design editor page (reference for bridge communication)
- `public/assets/js/page-builder-init.js` — Current page builder init (handles 2-way mode toggle)

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `templates/admin/design/browser.php` | Create | Design file browser — grid of .pen files with preview/duplicate/delete |
| 2 | `public/assets/js/design-mode-init.js` | Create | Design mode init — 3-way mode toggle, editor iframe, bridge, reconvert, form intercept |
| 3 | `templates/admin/content/edit.php` | Modify | Add "Design Editor" radio + design editor panel (split pane: editor + preview) |
| 4 | `public/assets/js/page-builder-init.js` | Modify | Remove mode toggle (moved to design-mode-init.js); keep only builder initialization |
| 5 | `app/Admin/DesignController.php` | Modify | Add browser(), duplicate(), deleteFile() methods |
| 6 | `app/Admin/ContentController.php` | Modify | Add reconvert() method; pass designFiles to edit()/create() templates |
| 7 | `public/index.php` | Modify | Register 4 new routes (browser, duplicate, delete, reconvert) |
| 8 | `public/assets/css/admin.css` | Modify | Add design-mode and design-browser CSS (~120 lines) |
| 9 | `templates/admin/layout.php` | Modify | Add "Design Files" sidebar nav link |

## Class Signatures

### `App\Admin\DesignController` (new methods)

```
public browser(Request $request): Response
    — Render admin/design/browser with designFiles list + csrfToken

public duplicate(Request $request): Response
    — JSON body: { source, target } → copy .pen file → { success: true }

public deleteFile(Request $request): Response
    — JSON body: { path } → check content refs via DB → delete if unused → { success: true }
```

### `App\Admin\ContentController` (new + modified)

```
public reconvert(Request $request, string $id): Response
    — JSON body: { design_file, csrf_token }
    — PenConverter::convertFile() → update content.body + content.design_file
    — Return { success, html, css }

edit() — MODIFY: load designFiles list, pass to template as 'designFiles'
create() — MODIFY: load designFiles list, pass to template as 'designFiles'
```

### `public/assets/js/design-mode-init.js` (key functions)

```
Mode toggle: 3-way (html/elements/design) — show/hide panels + pageStylesCard
buildEditorUrl(filePath) — build /assets/pencil-editor/index.html?baseUrl=&csrf=...&filePath=...
sendToBridge(action, payload) — postMessage to iframe { source: 'litecms-admin', action, payload }
loadDesignEditor(filePath) — set iframe src, update status
saveDesignFile(callback) — save via bridge, wait for file-saved event, timeout 5s
reconvertBtn click → saveDesignFile then POST /admin/content/{id}/reconvert
Form submit intercept → save design file before form submission (design mode only)
Listen for bridge: 'editor-ready', 'file-saved'
```

## New Routes

```
GET  /admin/design/browser           → DesignController::browser
POST /admin/design/duplicate         → DesignController::duplicate
POST /admin/design/delete            → DesignController::deleteFile
POST /admin/content/{id}/reconvert   → ContentController::reconvert
```

## Key Constraints

- Paths validated via existing `DesignController::sanitizePath()` — reuse it, do not reinvent
- CSRF token checked on all POST requests
- Delete endpoint must check DB for content references before deleting file
- Design editor iframe sandboxed: `allow-scripts allow-same-origin allow-popups allow-forms allow-modals allow-downloads`
- Bridge messages follow existing protocol: source `litecms-admin` → iframe, source `pencil-bridge` → parent
- `design-mode-init.js` owns the 3-way mode toggle; remove toggle from `page-builder-init.js`
- Form submit intercepted only when mode is `design` AND editor is ready AND file is set
- Preview iframe loads from `/admin/design/preview?path={file}` (existing endpoint)
- designFiles list: scan `designs/` recursively for `.pen` files, return `[{name, path}]` sorted by name
- Use `$this->e()` for all template output (XSS prevention)

## Verification

After implementation, run:
```
composer install
php tests/chunk-7.5-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

## Reference

For full code templates and detailed implementation notes, see `CHUNK-7.5-PLAN.md`.
