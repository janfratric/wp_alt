# Chunk 6.3 — Per-Instance Element Styling

## Goal

Add Elementor-like style controls to the page builder. Each element instance gets a "Style" tab with GUI controls (spacing, background, typography, border, effects, layout) plus a Custom CSS textarea for freeform CSS scoped to that instance. Page-level wrappers (page-body, container, site-main) get the same treatment via a sidebar card. Custom CSS is the primary integration point for AI-driven styling in Chunk 6.4.

## Context Files

- `CHUNK-6.3-PLAN.md` — Detailed reference with full code templates and class specs (consult if stuck)
- `tests/chunk-6.3-verify.php` — Automated tests you MUST pass before declaring done
- `app/PageBuilder/PageRenderer.php` — Current rendering (modify for inline styles + instance IDs)
- `app/PageBuilder/SlotRenderer.php` — Existing slot renderer (do NOT modify)
- `app/Admin/ContentController.php` — Current save/load logic (modify for style_data + page_styles)
- `app/Templates/FrontController.php` — Current element rendering branch (modify to append layout CSS)
- `public/assets/js/page-builder.js` — Current page builder JS (modify for tabs + style panel)
- `public/assets/js/page-builder-init.js` — Current init script (modify for page styles card toggle)
- `templates/admin/content/edit.php` — Current editor template (modify for page styles sidebar)
- `public/assets/css/admin.css` — Current admin styles (append style panel CSS)
- `migrations/004_page_builder.sqlite.sql` — Existing schema reference

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `migrations/005_element_styles.sqlite.sql` | Create | Add `style_data_json` column to `page_elements`, create `page_styles` table |
| 2 | `migrations/005_element_styles.mysql.sql` | Create | MySQL variant |
| 3 | `migrations/005_element_styles.pgsql.sql` | Create | PostgreSQL variant |
| 4 | `app/PageBuilder/StyleRenderer.php` | Create | CSS generation, scoping, and sanitization |
| 5 | `app/PageBuilder/PageRenderer.php` | Modify | Add style_data_json to SELECT, inline styles + data-instance-id on wrapper, custom CSS collection in getPageCss(), new getPageLayoutCss() |
| 6 | `app/Admin/ContentController.php` | Modify | Save/load style_data per instance, new savePageStyles/loadPageStyles, pass pageStyles to templates |
| 7 | `app/Templates/FrontController.php` | Modify | Append getPageLayoutCss() to elementCss in page() and blogPost() |
| 8 | `public/assets/js/page-builder.js` | Modify | Tab system (Content/Style), style panel with accordion sections, Custom CSS textarea, serialize styleData (~350 new lines) |
| 9 | `public/assets/js/page-builder-init.js` | Modify | Toggle #page-styles-card visibility on mode change |
| 10 | `public/assets/js/page-styles-init.js` | Create | Page-level style controls for sidebar card (~100 lines) |
| 11 | `templates/admin/content/edit.php` | Modify | Add Page Layout Styles card in sidebar, script tag for page-styles-init.js |
| 12 | `public/assets/css/admin.css` | Modify | Append ~170 lines: tabs, style panel, spacing controls, color fields, custom CSS textarea |

## Class Signatures

### `App\PageBuilder\StyleRenderer` (NEW)
```
static buildInlineStyle(array $styleData): string          // style_data keys → CSS property:value pairs
static getCustomClasses(array $styleData): string          // Extract/sanitize custom_class value
static buildPageLayoutCss(array $pageStyleData): string    // GUI styles → .page-body/.container/.site-main rules
static sanitizeStyleData(array $data): array               // Validate all style values (numeric clamp, color regex, whitelist selects)
static sanitizeCustomCss(string $css): string              // Strip @import, javascript:, expression(), </style>, <script>
static scopeCustomCss(string $css, string $scope): string  // Prepend scope selector to every CSS rule
private static sanitizeCssValue(string $value): string     // Block injection in individual values
private static sanitizeCssClass(string $value): string     // Strip to alphanumeric/hyphens/underscores/spaces
```

### `App\PageBuilder\PageRenderer` (MODIFY)
```
MODIFY loadInstances()     — Add 'page_elements.style_data_json' to SELECT
MODIFY renderInstance()    — Read style_data_json, apply inline style + data-instance-id
MODIFY getPageCss()        — After catalogue CSS, collect per-instance custom_css scoped via scopeCustomCss()
NEW    getPageLayoutCss(int $contentId): string  — Query page_styles, build GUI + custom CSS
```

### `App\Admin\ContentController` (MODIFY)
```
MODIFY savePageElements()  — Read style_data from JSON, sanitize, persist to style_data_json column
MODIFY loadPageElements()  — Add style_data_json to SELECT, include styleData in result
MODIFY create()            — Pass 'pageStyles' => [] to template
MODIFY edit()              — Pass 'pageStyles' => $this->loadPageStyles($id)
MODIFY store()             — Call $this->savePageStyles() after savePageElements()
MODIFY update()            — Call $this->savePageStyles() after savePageElements()
NEW    savePageStyles(int $contentId, Request $request): void
NEW    loadPageStyles(int $contentId): array
```

## Key Constraints

- Content (`slot_data_json`) and styling (`style_data_json`) are separate columns — never mix them
- GUI styles → inline `style` attribute on wrapper div; Custom CSS → scoped `<style>` block
- CSS specificity cascade: catalogue CSS → inline GUI styles → scoped custom CSS (each overrides previous)
- Every instance wrapper div gets `data-instance-id="{page_elements.id}"` for CSS scoping
- Custom CSS scoped via `[data-instance-id="N"]` attribute selector (never leaks to other instances)
- `sanitizeCustomCss()` MUST block: `@import`, `@charset`, `javascript:`, `expression()`, `behavior:`, `-moz-binding:`, `</style>`, `<script>`, `<!--`
- Page layout targets whitelist: `page_body`, `container`, `site_main` only
- Style panel uses native `<details>/<summary>` for accordion (no JS expand/collapse)
- All existing page builder features (drag/drop, picker, slot forms) must remain fully functional
- HTML-mode content rendering completely unchanged — no style_data or page_styles created

## Verification

After implementation, run:
```
composer install
php tests/chunk-6.3-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring done.

Then run full regression:
```
php tests/run-all.php --full
```

All previous chunks (1.1–6.2) must still pass.

Manual browser test:
1. Create/edit a page in elements mode → verify Content/Style tabs on each instance
2. Set padding + background color via GUI → save → view on frontend → verify inline style on wrapper
3. Write custom CSS in textarea (e.g. `h2 { color: red; }`) → save → verify scoped rule in `<style>` block
4. Set page layout styles on page-body target → save → verify CSS rule on frontend

## Reference

For full code templates, key mappings, whitelist values, edge cases, and security notes, see `CHUNK-6.3-PLAN.md`.
