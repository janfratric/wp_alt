# Chunk 7.1 — Embed Pencil Editor in LiteCMS Admin

## Goal

Port the Pencil visual design editor (a CanvasKit/Skia WASM SPA from its VS Code extension) into the LiteCMS admin panel. Create an IPC bridge that replaces the VS Code `window.vscodeapi` with `fetch()` calls to a PHP backend, build a `DesignController` for `.pen` file I/O, and wire it into admin navigation. At completion, admins can open `/admin/design/editor`, use a Figma-like canvas, and save/load `.pen` files to the server.

## Context Files

- `PROMPT.md` — Full project specification (tech stack, constraints, security requirements)
- `CHUNK-7.1-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `tests/chunk-7.1-verify.php` — Automated tests you MUST pass before declaring done
- `app/Admin/LayoutController.php` — Reference for controller patterns (constructor, withSecurityHeaders, etc.)
- `templates/admin/layout.php` — Current sidebar nav structure (add link under Design section)
- `public/index.php` — Current route registration (add design routes inside /admin group)

## Files to Create/Modify (in order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `designs/.gitkeep` | Create | Storage directory for `.pen` design files |
| 2 | `scripts/copy-pencil-editor.php` | Create | One-time setup: copies editor SPA from VS Code extension, patches index.html |
| 3 | `public/assets/pencil-editor/*` | Copy via script | Editor SPA files (~16MB): index.html (patched), assets/, images/ — skip .map files |
| 4 | `public/assets/js/pencil-bridge.js` | Create | IPC bridge: mocks `window.vscodeapi` + `window.canvaskitWasm`, routes editor messages to PHP via fetch() |
| 5 | `app/Admin/DesignController.php` | Create | PHP backend: editor page, .pen file load/save, asset import, file listing |
| 6 | `templates/admin/design/editor.php` | Create | Admin page: toolbar with file selector, iframe hosting editor, loading overlay, inline JS for file/status management |
| 7 | `public/assets/uploads/design/.htaccess` | Create | Disable script execution in design uploads directory |
| 8 | `public/index.php` | Modify | Add 5 routes inside /admin group for design endpoints |
| 9 | `templates/admin/layout.php` | Modify | Add "Design Editor" link in sidebar Design section |
| 10 | `public/assets/css/admin.css` | Modify | Add design editor page styles (toolbar, iframe wrapper, loading overlay, status badges) |
| 11 | `tests/chunk-7.1-verify.php` | Create | 30 automated tests |

## Class Signatures

### `App\Admin\DesignController`
```
__construct(App $app)
editor(Request $request): Response       // GET  — render admin page with editor iframe
load(Request $request): Response         // GET  — return .pen file content as JSON (?path=)
save(Request $request): Response         // POST — write .pen JSON to designs/ (CSRF validated)
importFile(Request $request): Response   // POST — save data URI image, return URL
list(Request $request): Response         // GET  — list .pen files in designs/
private sanitizePath(string $path): ?string          // path traversal prevention
private getDesignFileList(): array                   // scan designs/ for *.pen files
private withSecurityHeaders(Response $response): Response  // relaxed CSP for WASM editor
```
Private properties: `App $app`, `string $designsDir` (= `dirname(__DIR__, 2) . '/designs'`).

### `pencil-bridge.js` (IIFE — not a class)
```
window.vscodeapi = { postMessage(msg) }   // Mock VS Code API, routes to handleEditorMessage()
window.canvaskitWasm = './assets/pencil.wasm'  // WASM loader path

handleEditorMessage(msg)     // Switch on msg.method: initialized, load-file, file-changed, import-uri, get-recent-files, get-license, get-fullscreen
sendToEditor(method, payload, id?)  // window.postMessage with source:'vscode-extension'
respondToEditor(id, data)    // Reply to editor request by id
loadFile(path)               // GET /admin/design/load → send file-update to editor
saveFile(payload)            // POST /admin/design/save → notify parent of success
importFile(requestId, payload) // POST /admin/design/import-file → respond with URL
```
Reads `baseUrl`, `filePath`, `csrf` from URLSearchParams. Listens for parent messages with `source:'litecms-admin'`.

## Routes (inside /admin group)

```
GET  /design/editor       → DesignController::editor
GET  /design/load         → DesignController::load
POST /design/save         → DesignController::save
POST /design/import-file  → DesignController::importFile
GET  /design/list         → DesignController::list
```

## Key Constraints

- **Bridge loads before editor**: patched `index.html` uses `<script>` (not `type="module"`) for bridge, ensuring `window.vscodeapi` and `window.canvaskitWasm` exist before the editor module executes
- **CSP must be relaxed** on the editor page only: `'unsafe-eval'` (WASM), `'unsafe-inline'`, `worker-src blob:`, external font/image origins. Set `X-Frame-Options: SAMEORIGIN` (not DENY — editor is in an iframe)
- **iframe sandbox**: `allow-scripts allow-same-origin allow-popups allow-forms allow-modals` — all required for WASM + fetch + editor UI
- **Path traversal prevention**: `sanitizePath()` must reject `..`, null bytes, non-`.pen` extensions, and non-`[a-zA-Z0-9_\-/]` characters
- **CSRF token flow**: admin template → iframe query param → bridge reads via URLSearchParams → sent as `X-CSRF-Token` header + `_csrf_token` body field → DesignController validates against session
- **File writes use `LOCK_EX`** to prevent corruption from concurrent saves
- **Skip .map files** when copying editor (saves ~20MB)
- **Windows path normalization**: `getDesignFileList()` must replace `\` with `/` in paths from `RecursiveDirectoryIterator`
- **Data URI imports**: only allow `image/(png|jpe?g|gif|webp|svg\+xml)` MIME types, save with random hex filenames
- Every `.php` file starts with `<?php declare(strict_types=1);`

## Verification

```bash
php scripts/copy-pencil-editor.php
php tests/chunk-7.1-verify.php
php tests/run-all.php --quick
```

All tests must show `[PASS]`. Then manually verify:
```
1. Navigate to /admin/design/editor — canvas renders (not blank)
2. Create frame/text elements — mouse/keyboard interaction works
3. Save (Ctrl+S) — status shows "Saved", .pen file appears in designs/
4. Reload page — design restores from server
5. Console shows "[pencil-bridge] Editor initialized" — no VS Code API errors
```

## Reference

For full code templates, IPC protocol details, edge cases, and CSS rules, see `CHUNK-7.1-PLAN.md`.
