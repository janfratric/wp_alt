# Chunk 7.4 — AI Design Pipeline

## Goal

Extend the AI page generator to produce `.pen` design files using the design system from Chunk 7.3. When a user selects "Visual Design" mode, the AI creates a page composed of design system component references (`ref` nodes with `descendants` overrides). The generated `.pen` file is saved to disk, converted to HTML via PenConverter for preview and public rendering, and linked to the content record via a new `design_file` column.

## Context Files

- `CHUNK-7.4-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `app/AIAssistant/GeneratorPrompts.php` — Existing prompt methods (elements mode pattern to follow)
- `app/AIAssistant/PageGeneratorController.php` — Existing chat/create/parse flow
- `app/Admin/ContentController.php` — Content CRUD with editor_mode handling
- `app/PageBuilder/PenConverter.php` — `.pen` → HTML+CSS converter
- `designs/litecms-system.pen` — Design system component library
- `templates/admin/generator/index.php` — Generator UI template
- `public/assets/js/page-generator.js` — Generator frontend logic
- `tests/chunk-7.4-verify.php` — Automated tests you MUST pass before declaring done

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `migrations/010_design_file.sqlite.sql` | Create | Add `design_file` column to content table |
| 2 | `migrations/010_design_file.mysql.sql` | Create | Same for MySQL |
| 3 | `migrations/010_design_file.pgsql.sql` | Create | Same for PostgreSQL |
| 4 | `app/AIAssistant/GeneratorPrompts.php` | Modify | Add 3 new methods for design mode prompts |
| 5 | `app/AIAssistant/PageGeneratorController.php` | Modify | Design branch in chat/create/parse |
| 6 | `app/Admin/ContentController.php` | Modify | design_file support + previewPen endpoint |
| 7 | `public/index.php` | Modify | Add POST /admin/content/preview-pen route |
| 8 | `templates/admin/generator/index.php` | Modify | Add "Visual Design" mode button + design preview |
| 9 | `public/assets/js/page-generator.js` | Modify | Design mode handling in preview + create |
| 10 | `tests/chunk-7.4-verify.php` | Create | 20 automated verification tests |

## Class Signatures

### `GeneratorPrompts` (new methods)

```
static formatDesignSystemComponents(array $designSystemDoc): string
static penDesignGatheringPrompt(string $siteName, array $existingPages, ?array $typeFields, string $componentSummary): string
static penDesignGenerationPrompt(string $siteName, string $contentType, ?array $typeFields, string $componentSummary, array $variables, array $imageUrls = []): string
private static collectSlotNodes(array $node, int $depth = 0): array
```

`formatDesignSystemComponents` — Iterates `$designSystemDoc['children']`, filters `reusable: true`, recursively collects slot nodes (text nodes with IDs), returns formatted summary with component IDs and slot IDs.

### `PageGeneratorController` (modified methods)

```
chat(Request): Response              — Add design branch: load design system, build prompts
parseGeneratedContent(string $content, bool $isElements = false, bool $isDesign = false): ?array
create(Request): Response            — Assemble full .pen doc, save to disk, convert to HTML
private getDesignSystemDocument(): array  — Load + cache designs/litecms-system.pen
```

Key design: AI outputs only `pen_page` (page frame with ref nodes). PHP merges with design system before saving.

### `ContentController` (modified + new method)

```
store(): void      — Accept 'design' in editor_mode, persist design_file
update(): void     — Same pattern as store
edit(): void       — Pass designFile to template data
readFormData(): array  — Extract design_file from request
previewPen(Request): Response  — POST endpoint: accepts pen_page JSON, merges with design system, returns {success, html, css}
```

## Key Constraints

- **AI outputs page frame only** — `pen_page` with `ref` nodes + `descendants` overrides. PHP merges with `litecms-system.pen` components before saving. This reduces token usage and prevents drift.
- **Migration**: `ALTER TABLE content ADD COLUMN design_file VARCHAR(500) DEFAULT NULL;` — all 3 drivers identical.
- **File storage**: Generated designs save to `designs/pages/{slug}.pen`. The `content.design_file` column stores relative path (e.g., `pages/about-us.pen`).
- **Pre-converted HTML**: On create, convert via `PenConverter::convertDocument()` and store in `body` column. Public site serves pre-rendered HTML — no FrontController changes needed.
- **Route placement**: Register `POST /admin/content/preview-pen` BEFORE parameterized `{id}` routes in index.php.
- **Reuse existing patterns**: Follow the elements mode branch structure in `chat()` — add design as a third branch alongside html and elements.
- **Error handling**: If `litecms-system.pen` missing → RuntimeException. If PenConverter fails → body = empty placeholder. If AI returns invalid JSON → `parseGeneratedContent` returns null.
- **previewPen accepts both**: `pen_page` (page only, merged with design system) or `pen_document` (full document, converted directly).
- **READY_TO_GENERATE marker**: Same pattern as html/elements modes for the gathering → generation transition.

## Verification

After implementation, run:
```
composer install
php tests/chunk-7.4-verify.php
```

All 20 tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Key tests:
- Tests 1-3: Migration files exist, SQL correct, column created
- Tests 4-7: GeneratorPrompts methods exist, produce valid output with component IDs and slot info
- Tests 8-9: Controller handles design mode, parses design JSON correctly
- Tests 10-13: ContentController accepts design mode, previewPen works, route registered
- Tests 14-15: Template has design button, JS handles design mode
- Tests 16-19: .pen file save/reload, PenConverter renders, CRUD persists, descendants overrides work
- Test 20: Full pipeline integration (prompts → parse → assemble → convert → save → re-convert)

Then run regression:
```
php tests/run-all.php --full
```

## Reference

For full code templates, prompt text, test script, and detailed implementation notes, see `CHUNK-7.4-PLAN.md`.
