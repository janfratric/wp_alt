# Chunk 4.2 — AI Chat Panel Frontend

## Goal

Build the frontend AI chat panel integrated into the content editor. Add a collapsible side panel with chat interface, message rendering, "Insert" / "Replace" / "Copy" actions for pushing AI responses into TinyMCE, conversation history loading, and error handling. The panel communicates with the existing backend endpoints from Chunk 4.1 (`POST /admin/ai/chat`, `GET /admin/ai/conversations`) — no backend changes needed.

## Context Files

- `PROMPT.md` — Full project specification
- `CHUNK-4.2-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `tests/chunk-4.2-verify.php` — Automated tests you MUST pass before declaring done
- `public/assets/js/editor.js` — Existing editor JS (follow same vanilla JS patterns)
- `public/assets/js/admin.js` — Existing admin JS (follow same patterns)
- `public/assets/css/admin.css` — Existing styles (use CSS custom properties)
- `templates/admin/content/edit.php` — Current edit template to modify
- `app/Admin/AIController.php` — Backend endpoints (read-only, do not modify)

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `public/assets/js/ai-assistant.js` | CREATE | Chat panel logic: fetch API calls, message rendering, insert-to-editor, conversation loading |
| 2 | `public/assets/css/admin.css` | MODIFY | Add AI panel styles (~220 lines before responsive section) |
| 3 | `templates/admin/content/edit.php` | MODIFY | Add AI toggle button, panel HTML, script tag |

## Function Signatures — `ai-assistant.js`

Single IIFE, vanilla JS. State variables:
```
panelOpen: boolean, conversationId: int|null, contentId: int|null,
isLoading: boolean, csrfToken: string, loadingEl: Element|null
```

Functions:
```
initAIPanel()                      // Entry point on DOMContentLoaded; find #ai-panel, read contentId + csrfToken, attach listeners
togglePanel()                      // Show/hide #ai-panel; toggle .ai-panel-open on .editor-layout; trigger TinyMCE resize
sendMessage()                      // Read #ai-input, POST /admin/ai/chat JSON, append user+assistant bubbles
appendMessage(role, content)       // Create message bubble; assistant gets Insert/Replace/Copy action buttons
appendError(errorText)             // Error bubble; link to /admin/settings if API key related
appendSystemMessage(text)          // Centered system message (e.g. "New conversation started.")
showLoading() / hideLoading()      // Animated typing indicator (three bouncing dots)
loadConversation()                 // GET /admin/ai/conversations?content_id={id}, render history
insertToEditor(htmlContent)        // tinymce.activeEditor.insertContent(htmlContent)
replaceEditorContent(htmlContent)  // Confirm dialog → tinymce.activeEditor.setContent(htmlContent)
copyToClipboard(text)              // Strip HTML, navigator.clipboard.writeText() with fallback
showBtnFeedback(btn, text)         // Temporarily change button text (1500ms)
scrollToBottom()                   // Scroll #ai-messages to bottom
escapeHtml(str)                    // Escape via temporary div textContent→innerHTML
```

## CSS Additions — `admin.css`

Add before `/* --- Responsive: Tablet & Mobile --- */`:
```
Sections to add:
- .ai-toggle-wrapper, #ai-toggle-btn          // Toggle button styling
- #ai-panel, #ai-panel.active                 // Panel container (display:none → flex)
- .editor-layout.ai-panel-open                // 3-column grid: 1fr 320px 380px
- .ai-panel-header, .ai-panel-header-actions  // Panel title bar + New/Close buttons
- #ai-messages                                // Scrollable message container (flex column, gap)
- .ai-empty-state                             // Placeholder when no messages
- .ai-message, .ai-message-user/assistant     // Chat bubbles (right-aligned blue / left-aligned gray)
- @keyframes aiFadeIn                         // Bubble entrance animation
- .ai-message-content (per role)              // Typography inside assistant bubbles (h1-h3, p, ul, code)
- .ai-message-actions, .ai-action-btn         // Insert/Replace/Copy buttons below assistant messages
- .ai-message-error                           // Red error bubble
- .ai-message-system                          // Centered gray system message
- .ai-message-loading, .ai-typing-indicator   // Animated bouncing dots
- @keyframes aiTypingBounce                   // Dot bounce animation
- .ai-panel-input, textarea, #ai-send-btn    // Input area at bottom of panel
```

Add inside existing `@media (max-width: 768px)`:
```
- .editor-layout.ai-panel-open → grid-template-columns: 1fr
- #ai-panel.active → position: fixed; inset: 0; z-index: 1000 (full-screen overlay)
- #ai-messages → max-height: calc(100vh - 140px)
```

## Template Changes — `edit.php`

1. Add `#ai-toggle-btn` in page header (beside "Back to Content" link)
2. Add `data-content-id` attribute to `#content-form` (empty for new, integer for edit)
3. Add `#ai-panel` div as third child inside `.editor-layout` (after `.editor-sidebar`)
4. Add `<script src="/assets/js/ai-assistant.js"></script>` after `editor.js` script tag

Panel HTML structure:
```
#ai-panel
  .ai-panel-header → title + New/Close buttons
  #ai-messages → .ai-empty-state placeholder
  .ai-panel-input → textarea#ai-input + button#ai-send-btn
```

## Key Constraints

- Vanilla JS only — single IIFE, no modules, no jQuery (match `editor.js` patterns)
- Fetch API for HTTP requests with `Content-Type: application/json` and `X-CSRF-Token` header
- User messages: `textContent` (plain text, no HTML injection)
- Assistant messages: `innerHTML` (AI responses may contain HTML)
- `isLoading` flag prevents double-sends; disable send button during requests
- TinyMCE integration: check `tinymce.activeEditor` exists before insert/replace
- `replaceEditorContent()` must show confirm() dialog before replacing
- Use existing CSS custom properties (`--color-primary`, `--color-border`, `--card-shadow`, etc.)
- No backend changes — all routes exist from Chunk 4.1
- CSP-compliant: all JS from `'self'`, inline styles OK, fetch to same-origin

## Verification

After implementation, run:
```
php tests/chunk-4.2-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Then verify manually:
```
php -S localhost:8000 -t public
```
1. `GET /admin/content/create` → AI toggle button visible in header
2. Click "AI Assistant" → panel opens as third column, empty state shown
3. Type message + Enter → user bubble (blue, right), typing indicator, then assistant bubble (gray, left)
4. "Insert" button → AI HTML inserted into TinyMCE at cursor
5. "Replace" button → confirm dialog → replaces all TinyMCE content
6. "Copy" button → plain text copied to clipboard
7. "New" button → clears chat, shows system message
8. Navigate away and back → conversation history restored
9. Resize to <768px → panel becomes full-screen overlay
10. No API key → error message with link to /admin/settings

## Reference

For full code templates, CSS blocks, and detailed implementation notes, see `CHUNK-4.2-PLAN.md`.
