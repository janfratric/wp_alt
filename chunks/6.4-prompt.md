# Chunk 6.4 — AI Element Integration

## Goal

Connect the AI system to the element-based page builder. Four sub-features: (A) AI coding assistant in the element editor for writing HTML/CSS, (B) element-aware page generation, (C) approval flow for AI-proposed elements, (D) element catalogue context in the content editor AI.

## Context Files

- `CHUNK-6.4-PLAN.md` — Detailed reference with full code templates and class specs (consult if stuck)
- `tests/chunk-6.4-verify.php` — Automated tests you MUST pass before declaring done
- `app/AIAssistant/AIController.php` — Existing AI controller (pattern to follow for ElementAIController)
- `app/AIAssistant/PageGeneratorController.php` — Page generator (modify for element mode)
- `app/AIAssistant/GeneratorPrompts.php` — Prompt builders (add element-aware methods)
- `app/AIAssistant/ConversationManager.php` — Conversation CRUD (add element methods)
- `app/AIAssistant/ClaudeClient.php` — API client (reuse as-is, do NOT modify)
- `public/assets/js/ai-assistant.js` — Content editor AI wrapper (pattern to follow)
- `public/assets/js/ai-chat-core.js` — Shared chat UI module (reuse as-is, do NOT modify)
- `public/assets/js/page-generator.js` — Page generator JS (modify for element mode)
- `templates/admin/elements/edit.php` — Element editor template (add AI panel)
- `templates/admin/generator/index.php` — Generator template (add mode toggle)
- `app/Admin/ElementController.php` — Element CRUD (add proposal methods)
- `public/index.php` — Route registration (add 5 new routes)
- `migrations/004_page_builder.sqlite.sql` — Existing schema with `element_proposals` table

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `migrations/006_element_ai.sqlite.sql` | Create | `ALTER TABLE ai_conversations ADD COLUMN element_id INTEGER DEFAULT NULL` + index |
| 2 | `migrations/006_element_ai.mysql.sql` | Create | MySQL variant |
| 3 | `migrations/006_element_ai.pgsql.sql` | Create | PostgreSQL variant |
| 4 | `app/AIAssistant/ElementPrompts.php` | Create | System prompt for element coding assistant |
| 5 | `app/AIAssistant/ElementAIController.php` | Create | Chat + conversations endpoints for element AI |
| 6 | `public/assets/js/element-ai-assistant.js` | Create | Thin wrapper around AIChatCore for element editor |
| 7 | `app/AIAssistant/ConversationManager.php` | Modify | Add `findOrCreateForElement()`, `getHistoryForElement()` |
| 8 | `templates/admin/elements/edit.php` | Modify | Add AI panel markup, toggle button, scripts |
| 9 | `public/index.php` | Modify | 5 new routes (element AI + proposals) |
| 10 | `public/assets/css/admin.css` | Modify | `.element-editor-grid.ai-panel-open` grid rule |
| 11 | `app/AIAssistant/GeneratorPrompts.php` | Modify | Add `formatElementCatalogue()`, `elementGatheringPrompt()`, `elementGenerationPrompt()` |
| 12 | `app/AIAssistant/PageGeneratorController.php` | Modify | Handle `editor_mode = 'elements'` in chat + create |
| 13 | `templates/admin/generator/index.php` | Modify | Editor mode toggle (HTML vs Elements) in step 1 |
| 14 | `public/assets/js/page-generator.js` | Modify | `editorMode` state, element-based preview, pass in request |
| 15 | `app/Admin/ElementController.php` | Modify | Add `proposals()`, `approveProposal()`, `rejectProposal()` |
| 16 | `templates/admin/elements/proposals.php` | Create | Proposal review UI with approve/reject |
| 17 | `app/AIAssistant/AIController.php` | Modify | Append element catalogue to system prompt for element-mode content |

## Class Signatures

### `App\AIAssistant\ElementPrompts` (NEW)
```
static systemPrompt(string $siteName, ?array $element, array $catalogueElements = []): string
    Role: "HTML/CSS template coding assistant for element builder"
    Include: template syntax reference ({{slot}}, {{{slot}}}, {{#list}}, {{^key}}, {{key.sub}})
    Include: CSS scoping rule (.lcms-el-{slug})
    Include: current element context (name, slug, slots) or "creating new element"
    Output format: use ```html and ```css fenced code blocks

static formatElementForPrompt(?array $element): string
    Format single element metadata for prompt context
```

### `App\AIAssistant\ElementAIController` (NEW)
```
public chat(Request): Response
    POST /admin/ai/element/chat
    Accept: {message, element_id, conversation_id, model, current_html, current_css}
    element_id may be null (new element)
    Use ConversationManager::findOrCreateForElement()
    Build prompt via ElementPrompts::systemPrompt()
    Copy getApiKey(), resolveModel(), getSetting() from PageGeneratorController pattern

public conversations(Request): Response
    GET /admin/ai/element/conversations?element_id=N
    Use ConversationManager::getHistoryForElement()
```

### `App\AIAssistant\ConversationManager` (MODIFY)
```
NEW findOrCreateForElement(int $userId, ?int $elementId): array
    Query: user_id + element_id + content_id IS NULL
    Create if not found with element_id set, content_id null

NEW getHistoryForElement(int $userId, ?int $elementId): array
    Query: user_id + element_id + content_id IS NULL, ORDER BY updated_at DESC
```

### `App\AIAssistant\GeneratorPrompts` (MODIFY)
```
NEW static formatElementCatalogue(array $elements): string
    Format: "- {name} (slug: {slug}): {description}. Slots: {key} ({type}), ..."
    Empty array: "No elements in the catalogue yet."

NEW static elementGatheringPrompt(string $siteName, array $existingPages, ?array $typeFields, string $catalogue): string
    Like gatheringPrompt() but includes catalogue and element-aware instructions

NEW static elementGenerationPrompt(string $siteName, string $contentType, ?array $typeFields, string $catalogue, array $imageUrls = []): string
    Output: element-based JSON with "elements" array
    Each: {element_slug, slot_data} for existing, {element_slug: "__new__", new_element: {...}, slot_data} for new
```

### `App\AIAssistant\PageGeneratorController` (MODIFY)
```
MODIFY chat(): Read editor_mode from request. When 'elements': load catalogue,
    use elementGatheringPrompt/elementGenerationPrompt

MODIFY create(): When editor_mode='elements': set editor_mode on content, create
    page_elements for existing elements, element_proposals for __new__

NEW private createElementProposal(array $newElement, int $userId, ?int $conversationId): int
```

### `App\Admin\ElementController` (MODIFY)
```
NEW proposals(Request): Response — GET /admin/element-proposals, list pending proposals
NEW approveProposal(Request, string $id): Response — create element from proposal, mark approved
NEW rejectProposal(Request, string $id): Response — mark proposal rejected
```

### `App\AIAssistant\AIController` (MODIFY)
```
MODIFY buildSystemPrompt(?int $contentId): When content editor_mode='elements',
    append formatElementCatalogue() to system prompt. Add 'editor_mode' to SELECT.
```

## Key Constraints

- Reuse `AIChatCore` JS module — do not duplicate chat UI logic
- Element AI uses `enableAttachments: false` (code assistant, no images)
- Element AI `extraPayload()` sends `element_id`, `current_html`, `current_css` from live textareas
- Element AI `messageActions()` returns: Apply HTML, Apply CSS, Apply Both, Copy
- `extractCodeBlock(content, lang)` parses ` ```html ` and ` ```css ` fenced code blocks
- Apply functions set textarea values directly (`#el-html-template`, `#el-css`)
- `element_proposals` table already exists from migration 004 — use it directly
- For `__new__` elements in generation: `new_element` must include `html_template`, `css`, `slots_json` using micro-mustache syntax and `.lcms-el-{slug}` CSS scoping
- All existing AI features (content editor, page generator HTML mode) must remain fully functional
- All new routes go inside the `/admin` group (protected by AuthMiddleware)

## Verification

After implementation, run:
```
composer install
php tests/chunk-6.4-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring done.

Then run full regression:
```
php tests/run-all.php --full
```

All previous chunks (1.1–6.3) must still pass.

Manual browser tests:
1. Open element editor → toggle AI panel → send message → verify code blocks + Apply buttons work
2. AI page generator → select Elements mode → generate → verify element-based preview
3. AI proposes `__new__` element → appears in proposals list → approve → appears in catalogue
4. Content editor in elements mode → AI references available elements in responses

## Reference

For full code templates, edge cases, security notes, and implementation details, see `CHUNK-6.4-PLAN.md`.
