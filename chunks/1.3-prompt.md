# Chunk 1.3 — Authentication System

## Goal

Build the complete authentication system: session management with security hardening, CSRF protection middleware, login/logout controllers, rate limiting for failed logins, role-based authorization helper, and first-run admin user bootstrap. At completion, `/admin/*` routes are protected — unauthenticated users are redirected to a login form, and all mutating requests require a valid CSRF token.

## Context Files

- `PROMPT.md` — Full project specification (security requirements, auth module spec)
- `CHUNK-1.3-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `tests/chunk-1.3-verify.php` — Automated tests you MUST pass before declaring done

Read before coding (existing code you build on top of):
- `app/Core/App.php` — How controllers are instantiated and middleware is dispatched
- `app/Core/Request.php` — Input access (`input()`, `server()`, `cookie()`)
- `app/Core/Response.php` — Response factories (`redirect()`, `html()`)
- `app/Database/QueryBuilder.php` — Database API (`query()`, `where()`, `first()`, `insert()`, `count()`)
- `app/Templates/TemplateEngine.php` — Template rendering and `e()` escape helper
- `public/index.php` — Current bootstrap and route registration
- `migrations/001_initial.sqlite.sql` — Users table schema

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `app/Auth/Session.php` | **Create** | Static session helper — start, get/set, destroy, regenerate, flash messages |
| 2 | `app/Auth/CsrfMiddleware.php` | **Create** | CSRF token generation + validation on POST/PUT/DELETE |
| 3 | `app/Auth/AuthMiddleware.php` | **Create** | Redirects unauthenticated users away from /admin/* |
| 4 | `app/Auth/RoleMiddleware.php` | **Create** | Role-based authorization helper for controllers |
| 5 | `app/Auth/AuthController.php` | **Create** | Login form (GET), login handler (POST), logout (POST), rate limiting |
| 6 | `templates/auth/layout.php` | **Create** | Standalone auth layout with inline CSS (centered card) |
| 7 | `templates/auth/login.php` | **Create** | Login form with CSRF token and flash error/success display |
| 8 | `app/Templates/TemplateEngine.php` | **Modify** | Add `csrfField()` method |
| 9 | `templates/admin/layout.php` | **Modify** | Add logout form + flash message display |
| 10 | `public/index.php` | **Modify** | Session start, admin bootstrap, auth routes, middleware registration |

## Class Signatures

### `App\Auth\Session`
```
static start(): void                                         // Secure cookie params (httponly, samesite=Lax, secure when HTTPS)
static get(string $key, mixed $default = null): mixed
static set(string $key, mixed $value): void
static has(string $key): bool
static remove(string $key): void
static regenerate(): void                                    // session_regenerate_id(true)
static destroy(): void                                       // Clear session + delete cookie + session_destroy
static flash(string $key, ?string $message = null): ?string  // 2-arg: set | 1-arg: get-and-remove
```
Private `static bool $started = false`. Flash data stored in `$_SESSION['_flash']`.

### `App\Auth\CsrfMiddleware`
```
static handle(Request $request, callable $next): Response
```
Generates token via `bin2hex(random_bytes(32))`, stores in `$_SESSION['csrf_token']`. Validates `_csrf_token` POST field or `X-CSRF-TOKEN` header on POST/PUT/DELETE. Uses `hash_equals()`. Returns 403 on mismatch.

### `App\Auth\AuthMiddleware`
```
static handle(Request $request, callable $next): Response
```
Private const `PUBLIC_ADMIN_PATHS = ['/admin/login']`. Non-admin routes pass through. Protected admin routes require `Session::get('user_id')`, else redirect to `/admin/login`.

### `App\Auth\RoleMiddleware`
```
static check(string $requiredRole): ?Response                // null = OK, Response = 403
static require(string $role): \Closure                       // Returns middleware closure (future per-route use)
```
Reads `user_role` from session. Returns 403 Response if role doesn't match.

### `App\Auth\AuthController`
```
__construct(App $app)
showLogin(Request $request): Response                        // GET /admin/login
handleLogin(Request $request): Response                      // POST /admin/login
logout(Request $request): Response                           // POST /admin/logout
```
Private rate-limit helpers:
```
getRateLimitPath(string $ip): string                         // storage/cache/rate_limit/{sha256}.json
isRateLimited(string $ip): bool
recordFailedAttempt(string $ip): void                        // Locks after 5 failures for 15 min
clearFailedAttempts(string $ip): void
```

### `App\Templates\TemplateEngine` (add method)
```
csrfField(): string                                          // Returns <input type="hidden" name="_csrf_token" ...>
```

## Key Constraints

- Every `.php` file starts with `<?php declare(strict_types=1);`
- No framework imports — native PHP only
- Passwords: `password_hash($pw, PASSWORD_BCRYPT)` / `password_verify()`
- Session ID regenerated on login via `session_regenerate_id(true)`
- CSRF token: 64-char hex string, validated with `hash_equals()` (timing-safe)
- Rate limiting: file-based in `storage/cache/rate_limit/`, uses `LOCK_EX` for writes
- All template output uses `$this->e()` — no raw variable output
- Do NOT modify any existing class signatures — only add the `csrfField()` method to TemplateEngine
- No schema changes — the users table from Chunk 1.2 has all needed columns
- Default admin bootstrap: username=`admin`, password=`admin`, role=`admin`, email=`admin@localhost`

## Middleware Registration Order

In `public/index.php`, register in this order (first added = outermost):
1. `CsrfMiddleware::handle` — validates CSRF on all POST/PUT/DELETE
2. `AuthMiddleware::handle` — protects /admin/* routes

## Verification

After implementation, run:
```
composer install
php tests/chunk-1.3-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Then run full regression:
```
php tests/run-all.php --full
```

All previous chunk tests (1.1, 1.2) must still pass.

## Reference

For full code templates, detailed implementation notes, and edge cases, see `CHUNK-1.3-PLAN.md`.
