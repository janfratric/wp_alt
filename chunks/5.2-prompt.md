# Chunk 5.2 — Settings Panel & Site Configuration

## Goal

Expand the existing Settings panel (partially built in Chunk 4.1 for AI config) into a comprehensive site configuration interface with sections for General, SEO, Cookie Consent & Analytics, Contact Form, and Advanced. Critically, update `Config.php` so that database settings override file-based config values — making admin changes take effect immediately without touching `config/app.php`.

## Context Files

- `PROMPT.md` — Full project specification (settings sections defined under Chunk 5.2)
- `CHUNK-5.2-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `tests/chunk-5.2-verify.php` — Automated tests you MUST pass before declaring done
- `app/Admin/SettingsController.php` — Existing controller to expand (preserves AI settings from 4.1)
- `templates/admin/settings.php` — Existing template to expand (preserves AI section from 4.1)
- `app/Core/Config.php` — Existing config reader to add DB overlay to
- `app/Templates/FrontController.php` — Already fetches some settings; needs `cookie_consent_enabled` added

## What Already Exists (Do Not Rewrite)

- Settings routes (`GET/PUT /admin/settings`) in `public/index.php`
- Settings sidebar link in `templates/admin/layout.php`
- Cookie consent banner + JS (`templates/public/partials/cookie-consent.php`, `public/assets/js/cookie-consent.js`)
- GA loading via `data-ga-id` in `templates/public/layout.php`
- `FrontController::getPublicSettings()` already fetches `site_tagline`, `cookie_consent_text`, `cookie_consent_link`, `ga_enabled`, `ga_measurement_id`
- AI settings handling in SettingsController (API key encryption, model selection, AI params)

## Files to Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `app/Core/Config.php` | Rewrite | Add DB settings overlay; `$protectedKeys` safety; `loadDbSettings()`, `reset()` |
| 2 | `app/Core/App.php` | Edit (+5 lines) | Call `Config::loadDbSettings()` in constructor; re-apply timezone |
| 3 | `app/Admin/SettingsController.php` | Expand | Add handling for 15 new settings fields with validation |
| 4 | `templates/admin/settings.php` | Rewrite | Add General, SEO, Cookie/Analytics, Contact, Advanced sections |
| 5 | `app/Templates/FrontController.php` | Edit (small) | Add `cookie_consent_enabled` to fetched keys; pass `consentEnabled` |
| 6 | `templates/public/layout.php` | Edit (small) | Wrap cookie consent partial in `<?php if ($consentEnabled ?? true): ?>` |

No new files needed. No route changes. No migration changes.

## Class Signatures

### `App\Core\Config` (rewrite)
```
private static ?array $config = null                  // File-based config
private static ?array $dbSettings = null              // DB settings overlay
private static array $protectedKeys = [...]           // db_*, app_secret — never from DB

private static load(): void                           // (unchanged) Loads config/app.php
static loadDbSettings(): void                         // NEW: queries settings table via Connection::getInstance()
static get(string $key, mixed $default = null): mixed // MODIFIED: checks $dbSettings first (if not protected)
static getString(string $key, string $default = ''): string
static getInt(string $key, int $default = 0): int
static getBool(string $key, bool $default = false): bool
static all(): array                                   // MODIFIED: returns merged file+DB config
static reset(): void                                  // NEW: clears $config and $dbSettings
```
`loadDbSettings()` uses `Connection::getInstance()` directly (NOT Config::get) to avoid circular dependency. Catches all exceptions silently (table may not exist on first run).

### `App\Admin\SettingsController` (expand)
```
// Existing methods preserved:
index(Request $request): Response      // MODIFIED: pass timezones, all settings to template
update(Request $request): Response     // MODIFIED: handle 15 new fields + Config::reset()
private loadSettings(): array          // (unchanged)
private saveSetting(string $key, string $value): void  // (unchanged)
private withSecurityHeaders(Response $response): Response // (unchanged)

// New methods:
private saveCheckbox(Request $request, string $field): void
private static getTimezoneList(): array   // DateTimeZone::listIdentifiers() grouped by continent
```

## Settings Fields & Validation

| Setting | Type | Validation |
|---------|------|------------|
| `site_name` | string | Non-empty |
| `site_url` | string | Empty or `filter_var(FILTER_VALIDATE_URL)`, rtrim `/` |
| `site_tagline` | string | Any (allow empty) |
| `timezone` | string | Must be in `DateTimeZone::listIdentifiers()` |
| `items_per_page` | int | Clamp 1–100 |
| `default_meta_description` | string | `mb_substr($val, 0, 300)` |
| `og_default_image` | string | Any (allow empty) |
| `cookie_consent_enabled` | checkbox | Hidden input "0" + checkbox "1" pattern |
| `cookie_consent_text` | string | Any (allow empty) |
| `cookie_consent_link` | string | Any (allow empty) |
| `ga_enabled` | checkbox | Hidden input "0" + checkbox "1" pattern |
| `ga_measurement_id` | string | Empty or `/^G-[A-Z0-9]+$/` |
| `contact_notification_email` | string | Empty or `filter_var(FILTER_VALIDATE_EMAIL)` |
| `registration_enabled` | checkbox | Hidden input "0" + checkbox "1" pattern |
| `maintenance_mode` | checkbox | Hidden input "0" + checkbox "1" pattern |

## Template Section Order

`templates/admin/settings.php` sections in form order:
1. **General** — site name, site URL, tagline, timezone (select with optgroups), items per page
2. **SEO** — default meta description (textarea, maxlength 300), OG default image
3. **Cookie Consent & Analytics** — enable consent (checkbox), consent text (textarea), privacy link, hr, enable GA (checkbox), GA measurement ID
4. **Contact Form** — notification email
5. **AI Assistant** — (existing section, preserved exactly)
6. **Advanced** — enable registration (checkbox), maintenance mode (checkbox)

## Key Constraints

- **Protected keys**: DB must NEVER override `db_driver`, `db_path`, `db_host`, `db_port`, `db_name`, `db_user`, `db_pass`, `app_secret` — these always come from file config
- **Checkbox pattern**: Use `<input type="hidden" name="field" value="0">` before each checkbox so unchecked values are sent as "0"
- After saving settings, call `Config::reset()` so the redirect picks up fresh values
- `loadDbSettings()` must catch all `\Throwable` silently — table may not exist on fresh install
- Preserve the entire existing AI Assistant section in the template (API key, model dropdown, model management, API parameters)
- All `.php` files: `<?php declare(strict_types=1);`
- Templates use `$this->e()` for all output (XSS prevention)
- `cookie_consent_enabled` defaults to `'1'` if not set (banner shown by default)
- In `App::__construct()`, re-apply timezone after `loadDbSettings()` in case DB overrode it

## Verification

After implementation, run:
```
composer install
php tests/chunk-5.2-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Then run the full regression suite:
```
php tests/run-all.php --full
```

All previous chunk tests must still pass.

Then verify manually:
- Save a new site name → public site reflects it immediately
- Change items per page → blog pagination changes
- Enable GA + enter measurement ID → `data-ga-id` appears on public site body tag
- Disable GA → no `data-ga-id` on public site
- Change cookie consent text → banner shows new text
- Disable cookie consent → banner hidden on public site
- Settings persist after logout/login (DB-backed, not session)

## Reference

For full code templates, detailed implementation notes, edge cases, and complete template HTML, see `CHUNK-5.2-PLAN.md`.
