# Chunk 4.1 — Claude API Client & Backend

## Goal

Build the AI assistant backend: a thin Claude Messages API client (raw PHP curl, no SDK), a conversation manager persisting chat history in the existing `ai_conversations` table, the AI controller handling chat requests as a JSON endpoint, and a settings controller/page for encrypted API key storage and model selection. At completion, `POST /admin/ai/chat` accepts a message, calls Claude with content context and conversation history, and returns the AI response as JSON.

## Context Files

- `PROMPT.md` — Full project specification (AI module, security, schema)
- `CHUNK-4.1-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `tests/chunk-4.1-verify.php` — Automated tests you MUST pass before declaring done
- `app/Admin/ContentController.php` — Reference for controller pattern, security headers
- `app/Database/QueryBuilder.php` — Reference for query builder API
- `app/Auth/CsrfMiddleware.php` — Must be modified for header-based CSRF
- `public/index.php` — Must be modified to add routes

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `app/AIAssistant/ClaudeClient.php` | Create | Thin curl wrapper for Claude Messages API |
| 2 | `app/AIAssistant/ConversationManager.php` | Create | CRUD for `ai_conversations` table |
| 3 | `app/AIAssistant/AIController.php` | Create | JSON endpoint for chat + encrypt/decrypt utilities |
| 4 | `app/Admin/SettingsController.php` | Create | Settings page with API key management |
| 5 | `templates/admin/settings.php` | Create | Settings form (AI key, model, site name) |
| 6 | `app/Auth/CsrfMiddleware.php` | Modify | Add `X-CSRF-Token` header check for JSON APIs |
| 7 | `public/index.php` | Modify | Add imports + replace settings placeholder with real routes |

## Class Signatures

### `App\AIAssistant\ClaudeClient`
```
Constants: API_URL, API_VERSION ('2023-06-01'), MAX_TOKENS (4096), TIMEOUT_SECONDS (60)

__construct(string $apiKey, string $model = 'claude-sonnet-4-20250514')
sendMessage(array $messages, string $systemPrompt = '', int $maxTokens = 4096): array
    Returns: ['content' => string, 'usage' => array, 'model' => string, 'stop_reason' => string]
    Throws:  RuntimeException on network error, API error, missing key, or bad response format
```
Uses `curl_init()` / `curl_exec()`. Headers: `Content-Type`, `x-api-key`, `anthropic-version`. No streaming.

### `App\AIAssistant\ConversationManager`
```
findOrCreate(int $userId, ?int $contentId): array    — Find or create conversation for user+content pair
findById(int $id): ?array                            — Lookup by primary key
getMessages(array $conversation): array              — Parse messages_json into array
appendMessage(int $conversationId, string $role, string $content): array  — Append + save, returns updated array
getHistory(int $userId, ?int $contentId): array      — All conversations for user+content, newest first
delete(int $id): void
```
Stateless class. Messages stored as JSON: `[{role, content, timestamp}, ...]`.

### `App\AIAssistant\AIController`
```
__construct(App $app)
chat(Request $request): Response            — POST /admin/ai/chat (JSON in/out)
conversations(Request $request): Response   — GET  /admin/ai/conversations

static encrypt(string $plainText): string   — AES-256-CBC with sha256(app_secret), returns base64(iv+ciphertext)
static decrypt(string $cipherText): string  — Reverse of encrypt

private buildSystemPrompt(?int $contentId): string  — Includes content type/title/body excerpt
private getApiKey(): string                         — Settings table (encrypted) → config fallback (plain)
private getSetting(string $key, string $default): string
```
`chat()` reads JSON from `php://input`, not `$request->input()`. Returns `{success, response, conversation_id, usage}` on success, `{success: false, error}` on failure.

### `App\Admin\SettingsController`
```
__construct(App $app)
index(Request $request): Response    — GET  /admin/settings (admin-only)
update(Request $request): Response   — PUT  /admin/settings (admin-only)

private loadSettings(): array                       — All settings as ['key' => 'value'] map
private saveSetting(string $key, string $value): void — Upsert pattern
private withSecurityHeaders(Response $response): Response
```
API key is **never displayed** — template receives only a `$hasApiKey` boolean. Empty key field on submit preserves existing key.

## Routes to Register (inside `/admin` group)

```
GET  /admin/settings         → [SettingsController::class, 'index']
PUT  /admin/settings         → [SettingsController::class, 'update']
POST /admin/ai/chat          → [AIController::class, 'chat']
GET  /admin/ai/conversations → [AIController::class, 'conversations']
```
Remove the existing settings placeholder closure in `public/index.php`.

## Key Constraints

- Every `.php` file starts with `<?php declare(strict_types=1);`
- No SDK/library for Claude API — raw curl only
- API key encrypted at rest with AES-256-CBC: `openssl_encrypt()` with `sha256(app_secret)` key, random 16-byte IV prepended, base64-encoded for storage
- API key **never** returned to the browser — only a boolean "configured" flag
- JSON API endpoint (`/admin/ai/chat`) reads body from `php://input`, not `$_POST`
- CSRF for JSON: modify `CsrfMiddleware` to also accept token via `X-CSRF-Token` header (check `$_SERVER['HTTP_X_CSRF_TOKEN']`)
- `whereNull` for `content_id IS NULL`: use `QueryBuilder::raw()` if `whereNull()` doesn't exist on QueryBuilder — see Implementation Notes in the detailed plan
- System prompt includes content context: type, title, status, body excerpt (first 1000 chars, stripped of HTML tags)
- Conversation history persisted per user+content pair; full history sent to API for continuity
- Admin-only access for settings: check `Session::get('user_role') === 'admin'`

## Verification

After implementation, run:
```
composer install
php tests/chunk-4.1-verify.php
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Then run full regression:
```
php tests/run-all.php --full
```

All previous chunks must still pass.

## Reference

For full code templates, implementation notes, and edge cases, see `CHUNK-4.1-PLAN.md`.
