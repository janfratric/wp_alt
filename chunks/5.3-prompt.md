# Chunk 5.3 — AI Page Generator

## Goal

Build a conversational AI wizard accessible from the admin panel that guides users through creating a new webpage. The agent gathers requirements via iterative questions, generates complete HTML content with metadata as structured JSON, previews the result, and inserts a content record into the database. The created content is immediately editable in the standard content editor.

## Context Files

- `PROMPT.md` — Full project specification (tech stack, constraints, security requirements)
- `CHUNK-5.3-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `tests/chunk-5.3-verify.php` — Automated tests you MUST pass before declaring done
- `app/AIAssistant/ClaudeClient.php` — Existing Claude API client to reuse
- `app/AIAssistant/ConversationManager.php` — Existing conversation persistence to reuse
- `app/AIAssistant/AIController.php` — Reference for API key decryption pattern (`encrypt`/`decrypt`)
- `app/Admin/ContentController.php` — Reference for content insertion pattern (`store` method)
- `public/assets/js/ai-assistant.js` — Reference for fetch/chat UI patterns

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `app/AIAssistant/GeneratorPrompts.php` | Create | System prompts for gathering and generation phases |
| 2 | `app/AIAssistant/PageGeneratorController.php` | Create | Multi-step wizard backend (3 endpoints) |
| 3 | `templates/admin/generator/index.php` | Create | 4-step wizard UI (Setup → Describe → Preview → Done) |
| 4 | `public/assets/js/page-generator.js` | Create | Frontend: chat, preview, content creation |
| 5 | `templates/admin/layout.php` | Update | Add "Generate Page" link in sidebar Content section |
| 6 | `public/index.php` | Update | Register 3 routes in `/admin` group + add `use` import |
| 7 | `public/assets/css/admin.css` | Update | Append generator styles (~120 lines) |

## Class Signatures

### `App\AIAssistant\GeneratorPrompts`
```
static gatheringPrompt(string $siteName, array $existingPages, ?array $contentTypeFields): string
static generationPrompt(string $siteName, string $contentType, ?array $contentTypeFields): string
static formatExistingPages(array $pages): string
static formatCustomFields(array $fields): string
```
All static, no state. Gathering prompt tells AI to ask 2-3 questions per turn and emit `READY_TO_GENERATE` marker when done. Generation prompt instructs AI to return strict JSON: `{title, slug, excerpt, meta_title, meta_description, body, custom_fields}`. Body must be semantic HTML5 (no h1, no inline styles, no wrapper tags).

### `App\AIAssistant\PageGeneratorController`
```
__construct(App $app)
index(Request $request): Response                    // GET  /admin/generator
chat(Request $request): Response                     // POST /admin/generator/chat
create(Request $request): Response                   // POST /admin/generator/create

private getApiKey(): string                          // Decrypt from settings, fallback to config
private getModel(): string                           // Read claude_model from settings/config
private getExistingPages(): array                    // Published content titles+slugs for context
private getContentTypeFields(string $typeSlug): ?array  // null for page/post, decoded JSON for custom
private generateSlug(string $title): string          // Lowercase, hyphens, trim
private ensureUniqueSlug(string $slug): string       // Append -2, -3 etc.
private parseGeneratedContent(string $aiResponse): ?array  // Strip code fences, json_decode, validate
private withSecurityHeaders(Response $response): Response
```

### Routes to register (inside `/admin` group)
```
GET  /generator       → PageGeneratorController::index
POST /generator/chat  → PageGeneratorController::chat
POST /generator/create → PageGeneratorController::create
```

### JavaScript functions (`page-generator.js`)
```
init(), goToStep(step), onTypeSelected(typeSlug)
sendMessage(), requestGeneration(), checkReadyState(data)
appendMessage(role, content), formatResponse(text)
showLoading(), hideLoading(), scrollMessages()
populatePreview(data), createContent(status)
apiCall(url, data)
```
IIFE wrapper. State: `csrfToken, conversationId, contentType, currentStep, generatedData, isLoading`. Steps: `setup|gathering|preview|created`. Enter/Shift+Enter keybinding on input.

## Key Constraints

- Reuse existing `ClaudeClient`, `ConversationManager`, `AIController::decrypt()` — do NOT duplicate
- Content insertion follows same pattern as `ContentController::store()` (QueryBuilder, custom_fields loop)
- Two-phase conversation: gathering prompt (asks questions) → generation prompt (outputs JSON), switched via `step` parameter
- `READY_TO_GENERATE` marker in AI response triggers `step: 'ready'` in JSON response; frontend shows "Generate Page" button
- `parseGeneratedContent()` must handle markdown code fences around JSON and missing optional fields
- Generator conversations use `content_id = null` in `ai_conversations` table (not tied to existing content)
- Support all content types: built-in (page, post) + custom types from `content_types` table
- Custom field values stored in `custom_fields` table, same as ContentController
- All fetch calls include `X-CSRF-Token` header and `X-Requested-With: XMLHttpRequest`
- Every `.php` file: `<?php declare(strict_types=1);` — no framework imports
- Templates use `$this->e()` for all output

## Verification

After implementation, run:
```
composer install
php tests/chunk-5.3-verify.php
php tests/run-all.php --full
```

All tests must show `[PASS]`. Fix any `[FAIL]` before declaring this chunk complete.

Then verify manually:
```
php -S localhost:8000 -t public
```
- `GET /admin/generator` → 200, wizard UI with content type selector
- Sidebar shows "Generate Page" link (active when on generator page)
- Select a type → chat starts, AI asks questions
- After gathering → "Generate Page" button appears
- Click generate → preview shows title, slug, body, meta fields
- "Create as Draft" → content appears in `/admin/content` list as draft, editable in editor
- "Create & Publish" → content appears as published, accessible on public site
- Missing API key → helpful error message (not crash)
- Custom content types → custom fields populated in preview and saved to DB

## Reference

For full code templates, prompt text, CSS rules, and detailed implementation notes, see `CHUNK-5.3-PLAN.md`.
