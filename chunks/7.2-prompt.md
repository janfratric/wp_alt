# Chunk 7.2 — .pen-to-HTML Converter (PenConverter)

## Goal

Build a PHP converter that reads `.pen` JSON files and generates semantic HTML + CSS. Handle all node types (frame, text, rectangle, ellipse, path, ref, group, icon_font, line, polygon), CSS flexbox layout, fill/stroke/effects, typography, component resolution (`ref` → deep-clone + overrides), and variable resolution (`$--var` → CSS custom properties). At completion, any `.pen` design file can be converted to clean, renderable HTML+CSS.

## Context Files

- `PROMPT.md` — Full project spec
- `CHUNK-7.2-PLAN.md` — Detailed reference with full code templates (consult if stuck)
- `app/PageBuilder/PageRenderer.php` — Existing renderer to add `renderFromPen()` to
- `app/Admin/DesignController.php` — Existing controller to add convert/preview endpoints
- `app/Templates/FrontController.php` — Existing front controller to add design_file check
- `public/index.php` — Route registration
- `tests/chunk-7.2-verify.php` — Automated tests you MUST pass

## Files to Create/Modify (in dependency order)

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `app/PageBuilder/PenStyleBuilder.php` | Create | Stateless utility — converts .pen node properties to CSS declarations |
| 2 | `app/PageBuilder/PenNodeRenderer.php` | Create | Renders individual .pen node types into HTML+CSS pairs |
| 3 | `app/PageBuilder/PenConverter.php` | Create | Main orchestrator — reads .pen JSON, resolves components/variables, renders tree |
| 4 | `app/PageBuilder/PageRenderer.php` | Modify | Add `renderFromPen($penFilePath)` static method |
| 5 | `app/Admin/DesignController.php` | Modify | Add `convert()` and `preview()` endpoint methods |
| 6 | `app/Templates/FrontController.php` | Modify | Add `design_file` conditional check in render methods |
| 7 | `public/index.php` | Modify | Register 2 new routes |
| 8 | `tests/chunk-7.2-verify.php` | Create | 32 verification tests |

## Class Signatures

### `App\PageBuilder\PenStyleBuilder` (all `public static`)
```
resolveValue(mixed $value): string
resolveColor(mixed $color): string
hexToRgba(string $hex): string
buildFill(mixed $fill): string
buildFills(mixed $fills): string
buildStroke(mixed $stroke): string
buildEffects(mixed $effects): string
buildLayout(array $node): string
buildPadding(mixed $padding): string
buildTypography(array $node): string
buildSizing(array $node, string $parentLayout = 'horizontal'): string
buildDimension(string $dim, mixed $value, string $parentLayout = 'horizontal'): string
extractFallback(string $sizing): ?float
buildPosition(array $node): string
buildRotation(mixed $rotation): string
buildCornerRadius(mixed $radius): string
buildOpacity(mixed $opacity): string
buildClip(mixed $clip): string
buildTextColor(mixed $fill): string
buildAllStyles(array $node, bool $isAbsolute = false, string $parentLayout = 'horizontal'): string
```

### `App\PageBuilder\PenNodeRenderer` (all `public static`)
```
renderNode(array $node, PenConverter $converter): array
renderFrame(array $node, PenConverter $converter): array
renderText(array $node, PenConverter $converter): array
renderRectangle(array $node, PenConverter $converter): array
renderEllipse(array $node, PenConverter $converter): array
renderLine(array $node, PenConverter $converter): array
renderPolygon(array $node, PenConverter $converter): array
renderPath(array $node, PenConverter $converter): array
renderRef(array $node, PenConverter $converter): array
renderGroup(array $node, PenConverter $converter): array
renderIconFont(array $node, PenConverter $converter): array
```
Private: `inferFrameTag(string $name): string`, `inferTextTag(array $node): string`, `renderTextContent(mixed $content): string`, `generatePolygonPoints(int $sides, float $w, float $h, float $cornerRadius = 0): string`, `escapeHtml(string $text): string`

### `App\PageBuilder\PenConverter`
```
private __construct(array $document)
static convertFile(string $penPath): array          // Main entry — file path
static convertJson(string $json): array             // Alternative — JSON string
static convertDocument(array $document): array       // Alternative — pre-parsed array
getComponent(string $id): ?array
renderChildren(array $children): array               // Returns ['html' => ..., 'css' => ...]
renderNode(array $node): array
addIconFontImport(string $family, string $url): void
incrementRefDepth(): bool                            // Returns false if MAX_REF_DEPTH (10) exceeded
decrementRefDepth(): void
getParentLayout(): string
setParentLayout(string $layout): void
```
Private: `convert(): array`, `buildComponentRegistry(): void`, `buildVariableCss(): string`, `buildThemeCss(): string`, `resolveComponent(string $refId, array $overrides, ?array $descendants): array`, `applyDescendants(array &$node, array $descendants): void`, `findDescendant(array &$node, array $pathParts): ?array`, `deepClone(array $node): array`

### Integration modifications
```
PageRenderer::renderFromPen(string $penFilePath): array  // Delegates to PenConverter::convertFile()
DesignController::convert(Request $request): Response    // POST /admin/design/convert
DesignController::preview(Request $request): Response    // GET /admin/design/preview
```

## Key Constraints

1. Text `fill` → CSS `color` (not `background-color`). All other nodes: `fill` → `background-color`/`background`.
2. Gradient rotation: .pen is counter-clockwise from top. CSS is clockwise. Formula: `css_deg = (360 - pen_deg + 180) % 360`.
3. Fill arrays: .pen later fills render on top; CSS earlier backgrounds render on top — reverse array.
4. 8-digit hex `#RRGGBBAA` → convert to `rgba()`.
5. `fill_container(N)` / `fit_content(N)` — regex-extract fallback value. Main-axis fill → `flex: 1 1 {N}px; min-{dim}: 0;`. Cross-axis → `100%`.
6. Component (ref) resolution: deep-clone → merge root overrides → apply descendant overrides (slash-separated paths). Max depth = 10 to prevent circular refs.
7. Reusable nodes (`reusable: true`) are NOT rendered in output — only used as templates for ref instances.
8. Variable references (`$--name`) → `var(--name)` in CSS. Variables go in `:root {}`, themed overrides in `[data-theme="..."]` selectors.
9. FrontController design_file check is safe before the column exists (`?? null` guard).
10. Per-side stroke thickness: `{top, right, bottom, left}` → individual `border-{side}` declarations.

## Verification

```bash
composer install
php tests/chunk-7.2-verify.php
```

All 32 tests must show `[PASS]`. Fix any `[FAIL]` before declaring done.

Then smoke test:
```bash
php tests/run-all.php --quick
```

## Reference

For full code templates and detailed implementation notes, see `CHUNK-7.2-PLAN.md`.
